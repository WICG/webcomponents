<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Custom Elements</title>
  <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
  <script src='https://resources.whatwg.org/dfn.js' defer class='remove'></script>
  <link rel="stylesheet" href="../../assets/styles/respec-complement.css">
  <script class='remove'>
  function resolveBacklink() {
      // For dfn.js
      if (window.initDfn) {
          initDfn();
      }
  }
  var respecConfig = {
    shortName: "custom-elements",
    specStatus: "ED",
    useExperimentalStyles: true,
    edDraftURI: "https://w3c.github.io/webcomponents/spec/custom/",
    editors: [{
       name: "Domenic Denicola",
       url: "mailto:d@domenic.me",
       company: "Google, Inc."
    }],
    wg: "Web Platform Working Group",
    wgURI: "http://www.w3.org/WebPlatform/WG/",
    wgPublicList: "public-webapps",
    subjectPrefix: "[custom-elements]",
    postProcess: [resolveBacklink],
    license: "w3c-software-doc",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/webcomponents/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/webcomponents/labels/custom-elements'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/webcomponents/commits/gh-pages/spec/custom'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-webapps@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-webapps/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use Custom Elements?',
        href: 'http://caniuse.com/#feat=custom-elements'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/custom-elements/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/custom-elements'
      }]
    }],
    localBiblio:  {
      'WEBIDL': {
        title: 'Web IDL',
        href: 'https://heycam.github.io/webidl/',
        publisher: 'W3C',
        authors: [
            'Cameron McCormack',
            'Boris Zbarsky'
        ]
      }
    },
    wgPatentURI: "http://www.w3.org/2004/01/pp-impl/83482/status"
  };
  </script>
<style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
}
var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
}

.monkeypatch {
    background: #fff9b5;
}
</style>

</head>

<body>

<section id='abstract'>

<p>This specification describes the method for enabling the author to define and use new types of DOM elements in a document. It will eventually be upstreamed into [[!WHATWG-DOM]], [[!HTML]], and [[!WEBIDL]]. Sections which explicitly modify existing parts of these specifications are denoted with "DOM+", "HTML+", or "Web IDL+" in their titles.</p>

</section>

<section id='sotd'>

<!-- draft specific information on status goes here -->

</section>

<section id="conformance">

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<p>The IDL fragments in this specification must be interpreted as required for conforming IDL fragments, as described in the Web IDL specification [[!WEBIDL]].</p>
</section>

<section>
<h2 id="custom-elements">HTML+: Custom elements</h2>

<p class="monkeypatch">This section should be inserted into the section <a href="https://html.spec.whatwg.org/#semantics">The elements of HTML</a>, probably as a subsection following "Scripting" and before "Common idioms without dedicated elements".</p>

<section class="informative">
<h3 id="custom-elements-intro">Introduction</h3>

<p>Custom elements provide a way for authors to build their own fully-featured DOM elements. Although authors could always use non-standard tag names in their documents, with application-specific behavior added after the fact by scripting or similar, such elements have historically been non-conforming and not very functional. By <a lt="element definition">defining</a> a custom element, authors can inform the parser how to properly construct an element and how elements of that class should react to changes.</p>

<p>Custom elements are part of a larger effort to "rationalize the platform," by explaining existing platform features (like the elements of HTML) in terms of lower-level author-exposed extensibility points (like custom element registration). Although today there are many limitations on the capabilities of custom elements—both functionally and semantically—that prevent them from fully explaining the behaviors of HTML's existing elements, we hope to shrink this gap over time.</p>

<section>
<h4 id="custom-elements-custom-tag-example">Creating a custom tag</h4>

<p>For the purposes of illustrating how to create a <a>custom tag</a>, let's define a custom element that encapsulates rendering a small icon for a country flag. Our goal is to be able to use it like so:</p>

<pre class="highlight">
&lt;flag-icon country="nl">&lt;/flag-icon></pre>

<p>To do this, we first declare a class for the custom element, extending <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>:</p>

<pre class="highlight">
class FlagIcon extends HTMLElement {
  constructor() {
    super()
    this._countryCode = null
  }

  static get observedAttributes() { return ["country"]; }

  attributeChangedCallback(name, oldValue, newValue) {
    // name will always be "country" due to observedAttributes
    this._countryCode = newValue
    this._updateRendering()
  }
  connectedCallback() {
    this._updateRendering()
  }

  get country() {
    return this._countryCode
  }
  set country(v) {
    this.setAttribute("country", v)
  }

  _updateRendering() {
    // Left as an exercise for the reader. But, you'll probably want to
    // check this.ownerDocument.defaultView to see if we've been
    // inserted into a document with a browsing context, and avoid
    // doing any work if not.
  }
}</pre>

<p>We then need to use this class to define the element:</p>

<pre class="highlight">
customElements.define("flag-icon", FlagIcon);</pre>

<p>At this point, our above code will work! The parser, whenever it sees the <code>flag-icon</code> tag, will construct a new instance of our <code>FlagIcon</code> class, and tell our code about its new <code>country</code> attribute, which we then use to set the element's internal state and update its rendering (when appropriate).</p>

<p>You can also create <code>flag-icon</code> elements directly, using the DOM API:</p>

<pre class="highlight">
const flagIcon = document.createElement("flag-icon")
flagIcon.country = "jp"
document.body.appendChild(flagIcon)</pre>

<p>Finally, we can also use the custom element constructor itself. That is, the above code is equivalent to:</p>

<pre class="highlight">
const flagIcon = new FlagIcon()
flagIcon.country = "jp"
document.body.appendChild(flagIcon)</pre>

</section>

<section class="informative">
<h4 id="custom-elements-type-extension-example">Creating a type extension</h4>

<p><a lt="type extension">Type extensions</a> are a distinct kind of <a>custom element</a>, which are registered slightly differently and used very differently. They exist to allow reuse of behaviors from the existing elements of HTML, by extending those elements with new custom functionality. This is important since many of the existing behaviors of HTML elements can unfortunately not be duplicated by using purely <a lt="custom tag">custom tags</a>. Instead, <a lt="type extension">type extensions</a> allow the installation of custom construction behavior, lifecycle hooks, and prototype chain onto onto existing elements, essentially "mixing in" these capabilities on top of the already-existing element.</p>

<p><a lt="type extension">Type extensions</a> require a distinct syntax from <a lt="custom tag">custom tags</a> because user agents and other software key off an <a href="https://dom.spec.whatwg.org/#concept-element">element</a>'s <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> in order to identify the element's basic nature. That is, the concept of <a lt="type extension">type extensions</a> building on top of existing behavior depends crucially on the extended elements retaining their original <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a>.</p>

<p>In this example, we'll be creating a type extension named <code>plastic-button</code>, which behaves like a normal button but gets fancy animation effects added whenever you click on it. We start by defining a class, just like before, although this time we extend <a href="https://html.spec.whatwg.org/#htmlbuttonelement"><code>HTMLButtonElement</code></a> instead of <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>:</p>

<pre class="highlight">
class PlasticButton extends HTMLButtonElement {
  constructor() {
    super()

    this.addEventListener("click", () => {
      // Draw some fancy animation effects!
    })
  }
}</pre>

<p>When registering our custom element, we have to also specify the <code>extends</code> option:</p>

<pre class="highlight">
customElements.define("plastic-button", PlasticButton, { extends: "button" });</pre>

<p>In general, the name of the element being extended cannot be determined simply by looking at what element interface it extends, as many elements share the same interface (such as <code>q</code> and <code>blockquote</code> both sharing <code>HTMLQuoteElement</code>).</p>

<p>To use our type extension, we use the <code>is</code> attribute on a <code>button</code> element:</p>

<pre class="highlight">
&lt;button is="plastic-button">Click Me!&lt;/button></pre>

<p>Trying to use a <a>type extension</a> as a <a>custom tag</a> will <em>not</em> work; that is, <code>&lt;plastic-button>Click me?&lt;/plastic-button></code> will simply create a <a href="https://html.spec.whatwg.org/#htmlunknownelement"><code>HTMLUnknownElement</code></a> with no special behavior.</p>

<p>If you need to create a type extension programmatically, you can use the following form of <code>createElement</code>:</p>

<pre class="highlight">
const plasticButton = document.createElement("button", { is: "plastic-button" })
plasticButton.textContent = "Click me!"</pre>

<p>And as before, the constructor will also work:</p>

<pre class="highlight">
const plasticButton2 = new PlasticButton()
console.log(plasticButton2.localName);          // will output "button"
console.log(plasticButton2.getAttribute("is")); // will output "plastic-button"</pre>

<p>Notably, all the of the ways in which <a href="https://html.spec.whatwg.org/#the-button-element"><code>button</code></a> is special apply to such "plastic buttons" as well: their focus behavior, ability to participate in <a href="https://html.spec.whatwg.org/#form-submission-2">form submission</a>, the <a href="https://html.spec.whatwg.org/#attr-fe-disabled"><code>disabled</code></a> attribute, and so on.</p>
</section>
<section class="informative" id="custom-element-semantics">
<h4>Drawbacks of custom tags</h4>

<p>As specified below, and alluded to above, simply defining and using an element called <code>taco-button</code> does not mean that such elements represent buttons. That is, tools such as Web browsers, search engines, or accessibility technology will not automatically treat the resulting element as a button just based on its registered name.</p>

<p>To convey the desired button semantics to a variety of users, while still using a <a>custom tag</a>, a number of techniques would need to be employed:</p>

<ul>
    <li>The addition of the <code><a href="https://html.spec.whatwg.org/#attr-tabindex">tabindex</a></code> attribute would make the <code>taco-button</code> <a href="https://html.spec.whatwg.org/#interactive-content-2">interactive content</a>, thus making it <a href="https://html.spec.whatwg.org/#focusable-area">focusable</a>. Note that if the <code>taco-button</code> were to become logically disabled, the <code><a href="https://html.spec.whatwg.org/#attr-tabindex">tabindex</a></code> attribute would need to be removed.</li>

    <li>The addition of various ARIA attributes helps convey semantics to accessibility technology. For example, setting the <code>role</code> attribute to <code><a href="http://rawgit.com/w3c/aria/master/aria/aria.html#button">button</a></code> will convey the semantics that this is a button, enabling users to successfully interact with the control using usual button-like interactions in their accessibility technology. Setting the <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-label">aria-label</a></code> attribute is necessary to give the button an <a href="https://w3c.github.io/aria/aria/aria.html#dfn-accessible-name">accessible name</a>, instead of having accessibility technology traverse its child text nodes and announce them. And setting <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-disabled">aria-disabled</a></code> to "<code>true</code>" when the button is logically disabled conveys to accessibility technology the button's disabled state.</li>

    <li>The addition of event handlers to handle commonly-expected button behaviors helps convey the semantics of the button to Web browser users. In this case, the most relevant event handler would be one that proxies appropriate <code><a href="https://w3c.github.io/uievents/#event-type-keydown">keydown</a></code> events to become <code><a href="https://w3c.github.io/uievents/#event-type-click">click</a></code> events, so that you can activate the button both with keyboard and by clicking.</li>

    <li>In addition to the default visual styling provided for <code>taco-button</code> elements, the visual styling will also need to be updated to reflect changes in logical state, such as becoming disabled; that is, whatever stylesheet has rules for <code>taco-button</code> will also need to have rules for <code>taco-button[disabled]</code>.</li>
</ul>

<p>With these points in mind, a full-featured <code>taco-button</code> that took on the responsibility of conveying button semantics (including the ability to be disabled) might look something like this:</p>

<pre class="highlight">
class TacoButton extends HTMLElement {
  static get observedAttributes() { return ["disabled"]; }

  constructor() {
    super();

    this.addEventListener("keydown", e => {
      if (e.keyCode === 32 || e.keyCode === 13) {
        this.dispatchEvent(new MouseEvent("click", {
          bubbles: true,
          cancelable: true
        }));
      }
    });

    this.addEventListener("click", e => {
      if (this.disabled) {
        e.preventDefault();
        e.stopPropagation();
      }
    });

    this._observer = new MutationObserver(() => {
      this.setAttribute("aria-label", this.textContent);
    });
  }

  attachedCallback() {
    this.setAttribute("role", "button");
    this.setAttribute("tabindex", "0");

    this._observer.observe(this, {
      childList: true,
      characterData: true,
      subtree: true
    });
  }

  disconnectedCallback() {
    this._observer.disconnect();
  }

  get disabled() {
    return this.hasAttribute("disabled");
  }

  set disabled(v) {
    if (v) {
      this.setAttribute("disabled", "");
    } else {
      this.removeAttribute("disabled");
    }
  }

  attributeChangedCallback() {
    // only is called for the disabled attribute due to observedAttributes
    if (this.disabled) {
      this.setAttribute("tabindex", "-1");
      this.setAttribute("aria-disabled", "true");
    } else {
      this.setAttribute("tabindex", "0");
      this.setAttribute("aria-disabled", "false");
    }
  }
}</pre>

<p>Even with this rather-complicated element definition, the element is not a pleasure to use for consumers: it will be continually "sprouting" <code><a href="https://html.spec.whatwg.org/#attr-tabindex">tabindex</a></code> and <code>aria-*</code> attributes of its own volition. This is because as of now there is no way to specify default accessibility semantics or focus behavior for custom elements, forcing the use of these attributes to do so (even though they are usually reserved for allowing the consumer to override default behavior).</p>

<p>In contrast, a simple <a>type extension</a>, as shown in the previous section, would automatically inherit the semantics and behavior of the <a href="https://html.spec.whatwg.org/#the-button-element"><code>button</code></a> element, with no need to implement these behaviors manually. In general, for any element with nontrivial behavior and semantics which builds on top of existing elements of HTML, <a lt="type extension">type extensions</a> will be easier to developer, maintain, and consume.</p>

</section>

<section class="informative">
<h4 id="custom-elements-upgrades-examples">Upgrading elements after their creation</h4>

<p>Because <a>element definition</a> can occur at any time, a non-custom element could be <a lt="create an element">created</a>, and then later become a <a>custom element</a> after an appropriate <a data-lt="custom element definition">definition</a> is registered. We call this process "upgrading" the element, from a normal element into a custom element.</p>

<p><a href="#upgrades">Upgrades</a> enable scenarios where it may be preferable for <a lt="custom element definition">custom element definitions</a> to be registered after relevant elements has been initially created, such as by the parser. They allow progressive enhancement of the content in the custom element. For example, in the following HTML document the element definition for <code>img-viewer</code> is loaded asynchronously:</p>

<pre class="highlight">&lt;!DOCTYPE html>
&lt;title>Image viewer example&lt;/title>

&lt;img-viewer filter="Kelvin">
  &lt;img src="images/tree.jpg" alt="A beautiful tree towering over an empty savannah">
&lt;/img-viewer>

&lt;script src="js/elements/img-viewer.js" async>&lt;/script>
</pre>

<p>The definition for the <code>img-viewer</code> element here is loaded using a <a href="https://html.spec.whatwg.org/#the-script-element"><code>script</code></a> element marked with the <a href="https://html.spec.whatwg.org/#attr-script-async"><code>async</code></a> attribute, placed after the <code>&lt;img-viewer></code> tag in the markup. While the script is loading, the <code>img-viewer</code> element will be treated as an undefined element, similar to a <a href="https://html.spec.whatwg.org/#the-span-element"><code>span</code></a>. Once the script loads, it will define the <code>img-viewer</code> element, and the existing <code>img-viewer</code> element on the page will be upgraded, applying the custom element's definition (which presumably includes applying an image filter identified by the string "Kelvin", enhancing the image's visual appearance).</p>

<hr>

<p>Note that <a href="#upgrades">upgrades</a> only apply to elements in the document tree. (Formally, elements <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>.) An element that is not inserted into a document will stay un-upgraded. An example illustrates this point:</p>

<pre class="highlight">
&lt;!DOCTYPE html>
&lt;title>Upgrade edge-cases example&lt;/title>

&lt;example-element>&lt;/example-element>

&lt;script>
  "use strict";

  const inDocument = document.querySelector("example-element");
  const outOfDocument = document.createElement("example-element");

  // Before the element definition, both are HTMLElement:
  console.assert(inDocument instanceof HTMLElement);
  console.assert(outOfDocument instanceof HTMLElement);

  class ExampleElement extends HTMLElement {}
  customElements.define("example-element", ExampleElement);

  // After element definition, the in-document element was upgraded:
  console.assert(inDocument instanceof ExampleElement);
  console.assert(!(outOfDocument instanceof ExampleElement));

  document.body.appendChild(outOfDocument);

  // Now that we've moved the element into the document, it too was upgraded:
  console.assert(outOfDocument instanceof ExampleElement);
&lt;/script>
</pre>

</section>

</section>

<section>
<h3 id="custom-element-conformance">Requirements for custom element constructors</h3>

<p>When authoring <a lt="custom element constructor">custom element constructors</a>, developers are bound by the following <a href="https://html.spec.whatwg.org/#conformance-requirements-for-authors">conformance requirements</a>:</p>

<ul>
    <li>A parameter-less call to <code>super()</code> must be the first statement in the constructor body, to establish the correct prototype chain and <code>this</code> value before any further code is run.</li>
    <li>A <code>return</code> statement must not appear anywhere inside the constructor body, unless it is a simple early-return (<code>return</code> or <code>return this</code>).</li>
    <li>The element's attributes and children must not be inspected, as in the non-<a href="#upgrade">upgrade</a> case none will be present, and relying on upgrades makes the element less usable.</li>
    <li>The element must not gain any attributes or children, as this violates the expectations of consumers who use the <a href="https://dom.spec.whatwg.org/#dom-document-createelement"><code>createElement</code></a> or <a href="https://dom.spec.whatwg.org/#dom-document-createelementns"><code>createElementNS</code></a> methods.</li>
    <li>In general, work should be deferred to <code>connectedCallback</code> as much as possible—especially work involving fetching resources or rendering. However, note that <code>connectedCallback</code> can be called more than once, so any initialization work that is truly one-time will need a guard to prevent it from running twice.</li>
    <li>In general, the constructor should be used to set up initial state and default values, and to set up <a href="https://dom.spec.whatwg.org/#concept-event-listener">event listeners</a>.</li>
</ul>

<p>Several of these requirements are checked during element creation, either directly or indirectly, and failing to follow them will result in a custom element that cannot be instantiated by the parser or DOM APIs.</p>

</section>

<section>
<h3 id="custom-elements-core-concepts">Core concepts</h3>

<p>A <dfn id="dfn-custom-element">custom element</dfn> is an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that is <a>custom</a>. Informally, this means that its constructor and prototype are defined by the web developer, instead of by the user agent. This developer-supplied constructor function is called the <dfn id="dfn-custom-element-constructor">custom element constructor</dfn>.</p>

<p>Two distinct types of <a lt="custom element">custom elements</a> can be registered:</p>

<ol>
    <li>A <dfn id="dfn-custom-tag">custom tag</dfn>, which is registered with no <code>extends</code> option. These types of custom elements have <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> equal to their <a href="#dfn-element-definition-name">registered name</a>.</li>
    <li>A <dfn id="dfn-type-extension">type extension</dfn>, which is registered with an <code>extends</code> option. These types of custom elements have <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> equal to the value passed in their <code>extends</code> option, and their <a href="#dfn-element-definition-name">registered name</a> is used as the value of the <code>is</code> <a href="https://dom.spec.whatwg.org/#concept-named-attribute">attribute</a>.</li>
</ol>

<p>After a <a>custom element</a> is <a lt="create an element">created</a>, changing the value of the <code>is</code> <a href="https://dom.spec.whatwg.org/#concept-named-attribute">attribute</a> does not change the element's behavior.</p>

<p>A <a>custom tag</a> does not have any special meaning: it <a href="https://html.spec.whatwg.org/#represents">represents</a> its children. A <a>type extension</a> inherits the semantics of the element that it extends.</p>

<p>A <dfn id="valid-custom-element-name">valid custom element name</dfn> is a sequence of characters <var>name</var> that meets all of the following requirements:</p>

<ul>
    <li>
        <p><var>name</var> must match the <a><code>PotentialCustomElementName</code></a> production:</p>

        <dl>
            <dt><code><dfn id="prod-PotentialCustomElementName">PotentialCustomElementName</dfn> ::=</code></dt>
            <dd><code>[a-z] (<a>PCENChar</a>)* '-' (<a>PCENChar</a>)*</code></dd>

          <dt><code><dfn id="prod-PCENChar">PCENChar</dfn> ::=</code></dt>
            <dd><code>"-" | "." | [0-9] | "_" | [a-z] | #xB7 | [#xC0-#xD6] | [#xD8-#xF6] | [#xF8-#x2FF] | [#x300-#x37D] | [#x37F-#x1FFF] | [#x200C-#x200D] | [#x203F-#x2040] | [#x2070-#x218F] | [#x2C00-#x2FEF] | [#x3001-#xD7FF] | [#xF900-#xFDCF] | [#xFDF0-#xFFFD] | [#x10000-#xEFFFF]</code></dd>
        </dl>

        <p>This uses the <a href="https://www.w3.org/TR/xml/#sec-notation">EBNF notation</a> from the <cite>XML</cite> specification. [[!XML]]</p>
    </li>
    <li>
        <p><var>name</var> must not be any of the following:</p>
        <ul class="brief">
            <li><code>annotation-xml</code></li>
            <li><code>color-profile</code></li>
            <li><code>font-face</code></li>
            <li><code>font-face-src</code></li>
            <li><code>font-face-uri</code></li>
            <li><code>font-face-format</code></li>
            <li><code>font-face-name</code></li>
            <li><code>missing-glyph</code></li>
        </ul>
        <p class="note">The list of names above is the summary of all hyphen-containing element names from the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">applicable specifications</a>, namely <cite>SVG</cite> and <cite>MathML</cite>. [[SVG11]] [[MathML]]</p>
    </li>
</ul>

<div class="note">
    <p>These requirements ensure a number of goals for <a lt="valid custom element name">valid custom element names</a>:</p>

    <ul>
        <li>They start with a lowercase ASCII letter, ensuring that the HTML parser will treat them as tags instead of as text.</li>
        <li>They do not contain any uppercase ASCII letters, ensuring that the user agent can always treat HTML elements ASCII-case-insensitively.</li>
        <li>They contain a hyphen, used for namespacing and to ensure forward compatibility (since no elements will be added to HTML, SVG, or MathML with hyphen-containing tag names in the future).</li>
        <li>They can always be created with <a href="https://dom.spec.whatwg.org/#dom-document-createelement"><code>document.createElement</code></a> and <a href="https://dom.spec.whatwg.org/#dom-document-createelementns"><code>document.createElementNS</code></a>, which have restrictions that go beyond the parser's.</li>
    </ul>

    <p>Apart from these restrictions, a large variety of names is allowed, to give maximum flexibility for use cases like <code>&lt;math-α></code> or <code>&lt;emotion-😍></code>.</p>
</div>

<p>A <dfn id="dfn-element-definition">custom element definition</dfn> describes a <a>custom element</a> and consists of:</p>

<ul>
    <li>a <dfn id="dfn-element-definition-name" for="custom element definition">name</dfn>, which is a <a>valid custom element name</a>;</li>
    <li>a <dfn id="dfn-element-definition-local-name" for="custom element definition">local name</dfn>, which is a <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a>;</li>
    <li>a <dfn id="dfn-element-definition-constructor" for="custom element definition">constructor</dfn>, which is a <a>custom element constructor</a>;</li>
    <li>a <dfn id="dfn-element-definition-prototype" for="custom element definition">prototype</dfn>, which is a JavaScript object;</li>
    <li>a list of <dfn id="dfn-element-definition-observed-attributes">observed attributes</dfn>, which is a <code>sequence&lt;DOMString></code>; </li>
    <li>a collection of <dfn id="dfn-element-definition-lifecycle-callbacks" dfn-for="custom element definition">lifecycle callbacks</dfn>, which is a map (described below); </li>
    <li>a <dfn id="dfn-element-definition-construction-stack" for="custom element definition">construction stack</dfn>, which is a list (initially empty).</li>
</ul>

<p>Each <a>custom element definition</a>'s <a href="#dfn-element-definition-construction-stack">construction stack</a> is manipulated by the <a>upgrade an element</a> algorithm and the <a href="#dom-htmlelement-constructor"><code>HTMLElement</code> constructor</a>. Each entry in the list will be either an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> or an <dfn id="dfn-already-constructed-marker"><i>already constructed</i></dfn> marker.</p>

<p>Each <a>custom element definition</a>'s <a href="#dfn-element-definition-lifecycle-callbacks">lifecycle callbacks</a> is a map, whose three keys are the strings "<code>connectedCallback</code>", "<code>disconnectedCallback</code>", and "<code>attributeChangedCallback</code>". The corresponding values are either a JavaScript function object, or undefined. By default the value of each entry is undefined.</p>

</section>

<section>
<h3 id="custom-elements-api">The <code>CustomElementsRegistry</code> interface</h3>

<p>Each <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object is associated with a unique instance of a <code>CustomElementsRegistry</code> object, allocated when the <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object is created.</p>

<p class="note">Custom element registries are associated with <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> objects, instead of <a href="https://html.spec.whatwg.org/#document"><code>Document</code></a> objects, since each <a>custom element constructor</a> inherits from the <a href="https://html.spec.whatwg.org/#htmlelement"><code>HTMLElement</code></a> interface, and there is exactly one <a href="https://html.spec.whatwg.org/#htmlelement"><code>HTMLElement</code></a> interface per <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object.</p>

<p>The <code>customElements</code> attribute of the <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> interface must return the <code>CustomElementsRegistry</code> object for that <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object.</p>

<pre class='idl'>
interface CustomElementsRegistry {
  void define(DOMString name, Function constructor, optional ElementRegistrationOptions options);
};

dictionary ElementRegistrationOptions {
  DOMString extends;
};
</pre>

<div class="note">
    <dl class="domintro">
        <dt><var>window</var> . <code>customElements</code> . <a href="#dom-customelementsregistry-define"><code>define</code></a>(<var>name</var>, <var>constructor</var>)</dt>
        <dd>Defines a new <a>custom element</a>, mapping the given name to the given constructor as a <a>custom tag</a>.</dd>

        <dt><var>window</var> . <code>customElements</code> . <a href="#dom-customelementsregistry-define"><code>define</code></a>(<var>name</var>, <var>constructor</var>, { extends: <var>baseTagName</var> })</dt>
        <dd>Defines a new <a>custom element</a>, mapping the given name to the given constructor as a <a>type extension</a> for the supplied base tag.</dd>
    </dl>
</div>

<p>Every <code>CustomElementsRegistry</code> has a set of <a data-lt="custom element definition">custom element definitions</a>, initially empty. In general, algorithms in this specification look up elements in the registry by any of <a href="#dfn-element-definition-name">name</a>, <a href="#dfn-element-definition-local-name">local name</a>, or <a href="#dfn-element-definition-constructor">constructor</a>.</p>

<p>A <code>CustomElementsRegistry</code>'s <dfn id="dfn-document-list-of-defined-custom-elements">list of defined local names</dfn> is the list containing all of the <a href="#dfn-element-definition-local-name">local names</a> of the <a href="#dfn-element-definition">custom element definitions</a> in the registry.</p>

<p><dfn id="dfn-element-definition">Element definition</dfn> is a process of adding a <a>custom element definition</a> to the <code>CustomElementsRegistry</code>. This is accomplished by the <a href="#dom-customelementsregistry-define"><code>define</code></a> method. When invoked, the <dfn id="dom-customelementsregistry-define"><code>define(<var>name</var>, <var>constructor</var>, <var>options</var>)</code></dfn> method must run these steps:</p>

<ol>
    <li>If <a href="https://tc39.github.io/ecma262/#sec-isconstructor">IsConstructor</a>(<var>constructor</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> and abort these steps.</li>

    <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>name</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

    <li>If <var>name</var> is not a <a>valid custom element name</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>SyntaxError</code> and abort these steps.</li>

    <li>If this <code>CustomElementsRegistry</code> contains an entry with <a href="#dfn-element-definition-name">name</a> <var>name</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

    <li>If this <code>CustomElementsRegistry</code> contains an entry with <a href="#dfn-element-definition-constructor">constructor</a> <var>constructor</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

    <li>Let <var>localName</var> be <var>name</var>.</li>

    <li>Let <var>extends</var> be the value of the <code>extends</code> member of <var>options</var>, or null if no such member exists.</li>

    <li>
        <p>If <var>extends</var> is not null:</p>

        <ol>
            <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>extends</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

            <li>If there is no <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>extends</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

            <li>Set <var>localName</var> to <var>extends</var>.</li>
        </ol>
    </li>

    <li>Let <var>observedAttributesIterable</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "observedAttributes"). Rethrow any exceptions.</li>

    <li>If <var>observedAttributesIterable</var> is undefined, let <var>observedAttributes</var> be an empty <code>sequence&lt;DOMString></code>. Otherwise, let <var>observedAttributes</var> be the result of <a href="https://heycam.github.io/webidl/#es-sequence">converting</a> <var>observedAttributesIterable</var> to a <code>sequence&lt;DOMString></code>. Rethrow any exceptions.</li>

    <li>Let <var>prototype</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "prototype"). Rethrow any exceptions.</li>

    <li>If <a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a>(<var>prototype</var>) is not Object, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

    <li>Let <var>connectedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "connectedCallback"). Rethrow any exceptions.</li>

    <li>If <var>connectedCallback</var> is not undefined, and <a href="https://tc39.github.io/ecma262/#sec-iscallable">IsCallable</a>(<var>connectedCallback</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

    <li>Let <var>disconnectedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "disconnectedCallback"). Rethrow any exceptions.</li>

    <li>If <var>disconnectedCallback</var> is not undefined, and <a href="https://tc39.github.io/ecma262/#sec-iscallable">IsCallable</a>(<var>disconnectedCallback</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

    <li>Let <var>attributeChangedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "attributeChangedCallback"). Rethrow any exceptions.</li>

    <li>If <var>attributeChangedCallback</var> is not undefined, and <a href="https://tc39.github.io/ecma262/#sec-iscallable">IsCallable</a>(<var>attributeChangedCallback</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

    <li>Let <var>definition</var> be a new <a>custom element definition</a> with <a href="#dfn-element-definition-name">name</a> <var>name</var>, <a href="#dfn-element-definition-local-name">local name</a> <var>localName</var>, <a href="#dfn-element-definition-constructor">constructor</a> <var>constructor</var>, <a href="#dfn-element-definition-prototype">prototype</a> <var>prototype</var>, <a href="#dfn-element-definition-observed-attributes">observed attributes</a> <var>observedAttributes</var>, and <a href="#dfn-element-definition-lifecycle-callbacks">lifecycle callbacks</a> <var>connectedCallback</var>, <var>disconnectedCallback</var>, and <var>attributeChangedCallback</var> (stored by their corresponding name).</li>

    <li>Add <var>definition</var> to this <code>CustomElementsRegistry</code>.</li>
</ol>

</section>

<section>
<h3 id="upgrades">Upgrades</h3>

<p>To <dfn id="dfn-upgrade-a-custom-element">upgrade an element</dfn>, given as input a <a>custom element definition</a> <var>definition</var> and an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run the following steps:</p>

<ol>
    <li>Add <var>element</var> to the end of <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>Let <var>C</var> be <var>definition</var>'s <a href="#dfn-element-definition-constructor">constructor</a>.</li>

    <li>Let <var>constructResult</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>).</li>

    <li>Remove <var>element</var> from the end of <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>If <var>constructResult</var> is an abrupt completion, return <var>constructResult</var> (i.e., re-throw the exception).</li>

    <li>
        <p>If <a href="https://tc39.github.io/ecma262/#sec-samevalue">SameValue</a>(<var>constructResult</var>.[[\value]], <var>element</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>InvalidStateError</code> and terminate these steps.</p>

        <p class="note">This can occur if <var>C</var> constructs another instance of the same custom element before calling <code>super()</code>, or if <var>C</var> uses JavaScript's <code>return</code>-override feature to return an arbitrary object from the constructor.</p>
    </li>

    <li>Set <var>element</var>'s <a>defined flag</a> and <a>custom flag</a>.</li>

    <li>For each <var>attribute</var> in <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>, in order, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>

    <li>If <var>element</var> is currently <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</li>
</ol>

<p>To <dfn id="dfn-try-upgrade">try to upgrade an element</dfn>, given as input an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run the following steps:</p>

<ol>
  <li>If <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, abort this algorithm.</li>

  <li>Let <var>document</var> be <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</li>

  <li>If <var>document</var> does not have a <a href="https://html.spec.whatwg.org/#concept-document-bc">browsing context</a>, abort this algorithm.</li>

  <li>Let <var>registry</var> be <var>document</var>'s <a href="https://html.spec.whatwg.org/#concept-document-window">associated <code>Window</code></a>'s <code>CustomElementsRegistry</code> object.</li>

  <li>Let <var>definition</var> be null.</li>

  <li>
    <p>If <var>element</var> has an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> whose <a href="https://dom.spec.whatwg.org/#concept-attribute-qualified-name">qualified name</a> is "<code>is</code>", then:</p>

    <ol>
      <li>Let <var>is</var> be the value of that attribute.</li>

      <li>Set <var>definition</var> to the entry in registry with <a href="#dfn-element-definition-local-name">local name</a> equal to <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a>, and <a href="#dfn-element-definition-name">name</a> equal to <var>is</var>. If no such entry exists, abort this algorithm.</li>
    </ol>
  </li>

  <li>Otherwise, set <var>definition</var> to the entry in registry with <a href="#dfn-element-definition-local-name">local name</a> and <a href="#dfn-element-definition-name">name</a> equal to <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a>. If there is no such entry, abort this algorithm.</li>

  <li><a>Enqueue a custom element upgrade reaction</a> given <var>element</var> and <var>definition</var>.</li>
</ol>

</section>

<section id="enqueuing-and-invoking-callbacks">
<h3>Custom element reactions</h3>

<p>A <a>custom element</a> possesses the ability to respond to certain occurrences by running author code:</p>

<ul>
  <li>When <a href="#upgrades">upgraded</a>, its constructor is run.</li>
  <li>When it becomes <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>, its <code>connectedCallback</code> is run.</li>
  <li>When it becomes no longer <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>, its <code>disconnectedCallback</code> is run.</li>
  <li>When any of its <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attributes</a> are <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change">changed</a>, <a href="https://dom.spec.whatwg.org/#concept-element-attributes-append">appended</a>, <a href="https://dom.spec.whatwg.org/#concept-element-attributes-remove">removed</a>, or <a href="https://dom.spec.whatwg.org/#concept-element-attributes-replace">replaced</a>, its <code>attributeChangedCallback</code> is run.</li>
</ul>

<p>We call these reactions collectively <dfn id="dfn-custom-element-reaction">custom element reactions</dfn>.</p>

<p>The way in which <a>custom element reactions</a> are invoked is done with special care, to avoid running author code during the middle of delicate operations. Effectively, they are delayed until "just before returning to user script". This means that for most purposes they appear to execute synchronously, but in the case of complicated composite operations (like <a href="https://dom.spec.whatwg.org/#concept-node-clone">cloning</a>, or <a href="https://dom.spec.whatwg.org/#concept-range">range</a> manipulation), they will instead be delayed until after all the relevant user agent processing steps have completed, and then run together as a batch.</p>

<p>Additionally, the precise ordering of these reactions is managed via a somewhat-complicated stack-of-queues system, described below. The intention behind this system is to guarantee that <a>custom element reactions</a> always are invoked in the same order as their triggering actions, at least within the local context of a single <a>custom element</a>. (Because <a lt="custom element reactions">custom element reaction</a> code can perform its own mutations, it is not possible to give a global ordering guarantee across multiple elements.)</p>

<hr>

<p>Each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has a <dfn id="dfn-custom-element-reactions-stack">custom element reactions stack</dfn>, which is initially empty. Each item in the stack is an <dfn id="dfn-element-queue">element queue</dfn>, which is initially empty as well; the <a>element queue</a> at the top of the stack is called the <dfn id="dfn-current-element-queue">current element queue</dfn>. Each item in an <a>element queue</a> is an <a href="https://dom.spec.whatwg.org/#concept-element">element</a>. (The elements are not necessarily <a>custom</a> yet, since this queue is used for <a href="#upgrades">upgrades</a> as well.)</p>

<p>All <a href="https://dom.spec.whatwg.org/#concept-element">elements</a> have an associated <dfn id="dfn-callback-queue">custom element reaction queue</dfn>, initially empty. Each item in the <a>custom element reaction queue</a> is of one of two types:</p>

<ul>
    <li>An <dfn>upgrade reaction</dfn>, which will <a href="#upgrades">upgrade</a> the custom element and contains a <a>custom element definition</a>; or</li>
    <li>A <dfn>callback reaction</dfn>, which will call a lifecycle callback, and contains a <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> as well as a list of arguments.</li>
</ul>

<p>This is all summarized in the following schematic diagram:</p>

<p style="text-align: center;">
    <img src="custom-element-reactions.svg" style="width: 80%; max-width: 560px;" alt="A custom elements reaction stack consists of a stack of element queues. Zooming in on a particular queue, we see that it contains a number of elements (in our example, &lt;x-a&gt;, then &lt;x-b&gt;, then &lt;x-c&gt;). Any particular element in the queue then has a custom element reaction queue. Zooming in on the custom element reaction queue, we see that it contains a variety of queued-up reactions (in our example, upgrade, then attribute changed, then another attribute changed, then connected).">
</p>

<p>To <dfn id="dfn-enqueue-lifecycle-callback">enqueue a custom element callback reaction</dfn>, given a <a>custom element</a> <var>element</var>, a callback name <var>callbackName</var>, and a list of arguments <var>args</var>, run the following steps:</p>

<ol>
    <li>Let <var>document</var> be <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</li>

    <li>If <var>document</var> does not have a <a href="https://html.spec.whatwg.org/#concept-document-bc">browsing context</a>, abort these steps.</li>

    <li>Let <var>registry</var> be <var>document</var>'s <a href="https://html.spec.whatwg.org/#concept-document-window">associated <code>Window</code></a>'s <code>CustomElementsRegistry</code> object.</li>

    <li>
        Let <var>definition</var> be the the entry in <var>registry</var> with <a href="#dfn-element-definition-name">name</a> equal to <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>.

        <p class="note">This algorithm can only be called when such a definition exists.</p>
    </li>

    <li>Let <var>callback</var> be the value of the entry in <var>definition</var>'s <a href="#dfn-element-definition-lifecycle-callbacks">lifecycle callbacks</a> with key <var>callbackName</var>.</li>

    <li>If <var>callback</var> is undefined, abort these steps.</li>

    <li>
        <p>If <var>callbackName</var> is "<code>attributeChangedCallback</code>":</p>

        <ol>
            <li>Let <var>attributeName</var> be the the first element of <var>args</var>.</li>
            <li>If <var>definition</var>'s <a href="#dfn-element-definition-observed-attributes">observed attributes</a> does not contain <var>attributeName</var>, abort these steps.</li>
        </ol>
    </li>

    <li>Add a new <a>callback reaction</a> to <var>element</var>'s <a>custom element reaction queue</a>, with <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> <var>callback</var> and arguments <var>args</var>.</li>

    <li>Add <var>element</var> to the <a>current element queue</a>.</li>
</ol>

<p>To <dfn id="dfn-enqueue-upgrade">enqueue a custom element upgrade reaction</dfn>, given an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var> and <a>custom element definition</a> <var>definition</var>, run the following steps:</p>

<ol>
    <li>Add a new <a>upgrade reaction</a> to <var>element</var>'s <a>custom element reaction queue</a>, with <a>custom element definition</a> <var>definition</var>.</li>

    <li>Add <var>element</var> to the <a>current element queue</a>.</li>
</ol>

<p>To <dfn id="dfn-invoke-custom-element-actions">invoke custom element reactions</dfn> in an <a>element queue</a> <var>queue</var>, run the following steps:</p>

<ol>
    <li>
        <p>For each <a>custom element</a> <var>element</var> in <var>queue</var>:</p>

        <ol>
            <li>Let <var>actions</var> be <var>element</var>'s <a>custom element reaction queue</a>.</li>
            <li>
                <p>Repeat until <var>actions</var> is empty:</p>

                <ol>
                    <li>
                        <p>Remove the first element of <var>actions</var>, letting <var>action</var> be the result. Switch on <var>action</var>'s type:</p>

                        <dl class="switch">
                            <dt><a>upgrade reaction</a></dt>
                            <dd><a href="#dfn-upgrade-a-custom-element">Upgrade</a> <var>element</var> using <var>action</var>'s <a>custom element definition</a>.</dd>

                            <dt><a>callback reaction</a></dt>
                            <dd><a href="https://heycam.github.io/webidl/#es-invoking-callback-functions">Invoke</a> <var>action</var>'s <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> with <var>action</var>'s arguments, and with <var>element</var> as the <a href="https://heycam.github.io/webidl/#dfn-callback-this-value">callback this value</a>.</dd>
                        </dl>

                        <p>If this throws any exception, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>.</p>
                    </li>
                </ol>
            </li>
        </ol>
    </li>
</ol>

<hr>

<p class="warning">The following needs to be formalized more; see <a href="https://github.com/w3c/webcomponents/issues/186">#186</a>.</p>

<p>Any time a script calls a method, reads or sets a property that is implemented by the user agent, the following actions MUST occur:</p>
<ul>
    <li>When transitioning from script to the user agent code, push a new <a>element queue</a> to the <a>custom element reactions stack</a></li>
    <li>When transitioning back from the user agent code to script, pop the <a>element queue</a> from the <a>custom element reactions stack</a> and <a>invoke custom element reactions</a> in that queue.</li>
</ul>

<div class="note">As described, these actions wrap every user agent-implemented method or property accessor. The intended effect is that any lifecycle callbacks, enqueued as a result of running these methods or accessors are invoked prior to returning control back to script. If a method or accessor is known to never enqueue a custom element action, the user agent could choose not to wrap it as a performance optimization.</div>

</section>

</section>

<section>
<h2 id="concepts">Miscellaneous patches</h2>

<section id="window-modifications-to-html">
<h3>HTML+: The <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object</h3>

<p class="monkeypatch">HTML's <code>Window</code> object definition must be extended as follows:</p>

<pre class="idl">
partial interface Window {
    readonly attribute CustomElementsRegistry customElements;
};
</pre>

<p class="monkeypatch">As is conventional for HTML, the actual definition of this property is elsewhere in the specification (cf. <code>location</code> and <code>history</code>). We have it above in the section "<a href="#custom-elements-api">The <code>CustomElementsRegistry</code> interface</a>".</p>
</section>

<section id="element-interface-modifications-to-html">
<h3>HTML+: Element interfaces</h3>

<p class="monkeypatch">HTML currently does not do a great job of defining DOM's <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> concept. There is a definition hidden inside <a href="https://html.spec.whatwg.org/#create-an-element-for-the-token">the parser</a>, but it isn't explicit that this also covers other element creation cases. We should create a section that is more explicit, and it should roughly contain the following (including the note afterward):</p>

<p>The <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for an element with name <var>name</var> in the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a> is determined as follows:</p>

<ol>
    <li>If this specification defines an interface appropriate for the element type corresponding to the tag name <var>name</var>, return that interface.</li>
    <li>If <a href="https://html.spec.whatwg.org/multipage/#other-applicable-specifications">other applicable specifications</a> define such an appropriate interface for <var>name</var>, return the interface they define.</li>
    <li>If <var>name</var> is a <a>valid custom element name</a>, return <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>.</li>
    <li>Otherwise, return <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</li>
</ol>

<p class="note">
    The use of <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> instead of <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement"><code>HTMLUnknownElement</code></a> in the case of <a lt="valid custom element name">valid custom element names</a> is done to ensure that any potential future <a href="#upgrades">upgrades</a> only cause a linear transition of the element's prototype chain, from <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> to a subclass, instead of a lateral one, from <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement"><code>HTMLUnknownElement</code></a> to an unrelated subclass.
</p>

</section>

<section id="unresolved-element-pseudoclass">
<h3>HTML+: Pseudo-classes</h2>

<p class="monkeypatch">The following should be added to HTML's <a href="https://html.spec.whatwg.org/#pseudo-classes">pseudo-classes</a> section.</p>

<dl>
  <dt><dfn data-dfn-type="selector"><code>:defined</code></dfn></dt>
  <dd>The <a><code>:defined</code></a> pseudo-class must match any element that is <a>defined</a>.</p></dd>
</dl>

</section>

<section id="htmlelement-constructor">
<h3>HTML+: The <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> constructor</h3>

<p class="monkeypatch">The <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface gains following annotation:</p>

<pre>
[Constructor]
</pre>

<p class="monkeypatch">We then add the following definition:</p>

The <dfn id="dom-htmlelement-constructor"><code>HTMLElement</code> constructor</dfn>, when invoked, must perform the following steps:

<ol>
    <li>Let <var>realm</var> be the result of <a href="https://tc39.github.io/ecma262/#sec-getfunctionrealm">GetFunctionRealm</a>(the currently executing <code>HTMLElement</code> function).</li>

    <li>Let <var>registry</var> be <var>realm</var>'s [[\GlobalObject]]'s <code>CustomElementsRegistry</code> object.</li>

    <li>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#dfn-element-definition-constructor">constructor</a> equal to NewTarget. If there is no such definition, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> and abort these steps.</li>

    <li>
        <p>If <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a> is empty, perform the following substeps:</p>

        <ol>
            <li>Let <var>localName</var> be the <var>definition</var>'s <a href="#dfn-element-definition-local-name">local name</a>.</li>

            <li>Return a new element that implements <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</li>
        </ol>

        <p class="note">This occurs when author script constructs a new custom element directly, e.g. via <code>new MyCustomElement()</code>.</p>
    </li>

    <li>Let <var>instance</var> be the last entry in <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>
        <p>If <var>instance</var> is an <a><i>already constructed</i></a> marker, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> an <code>InvalidStateError</code> and abort these steps.</p>

        <p class="note">This can occur when the author code inside the <a>custom element constructor</a> invokes <code>super()</code> multiple times.</p>
    </li>

    <li>Let <var>prototype</var> be <var>definition</var>'s <a href="#dfn-element-definition-prototype">prototype</a>.</li>

    <li>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</li>

    <li>Replace the last entry in <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a> with an <a><i>already constructed</i></a> marker.</li>

    <li>
        <p>Return <var>instance</var>.</p>

        <p class="note">This step is normally reached when <a href="#upgrades">upgrading</a> a custom element; the existing element is returned, so that the <code>super()</code> call inside the <a>custom element constructor</a> assigns that existing element to <code>this</code>.</p>
    </li>
</ol>

<p class="note">For now, the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> constructor cannot be invoked directly. It only works when used via a <code>super()</code> call inside a <a>custom element constructor</a>.</p>

</section>

<section id="parsing">
<h3>HTML+: Parsing HTML documents</h3>

<p class="monkeypatch">The <a href="https://html.spec.whatwg.org/#create-an-element-for-the-token">create an element for a token</a> algorithm should be adjusted by replacing step 1 with the following steps, and adjusting further steps to refer to <var>element</var> instead of "the element" or "the newly created element".</p>

<ol>
    <li>Let <var>document</var> be <var>intended parent</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</li>

    <li>Let <var>localName</var> be the tag name of the token.</li>

    <li>Let <var>typeExtension</var> be null.</li>

    <li>Let <var>will execute script</var> be false.</li>

    <li>
        <p>If <var>given namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and <var>document</var> has a <a href="https://html.spec.whatwg.org/#concept-document-bc">browsing context</a>, and <var>localName</var> is in the <a>list of defined local names</a> for <var>document</var>'s <a href="https://html.spec.whatwg.org/#concept-document-window">associated <code>Window</code></a>'s <code>CustomElementsRegistry</code> object:</p>

        <ol>
            <li>Set <var>typeExtension</var> to the value of the "<code>is</code>" attribute in the given token, if such an attribute exists.</li>

            <li>Set <var>will execute script</var> to true if the parser was not originally created for the <a href="https://html.spec.whatwg.org/#html-fragment-parsing-algorithm">HTML fragment parsing algorithm</a>.</li>
        </ol>
    </li>

    <li>
        <p>If <var>will execute script</var> is true:</p>

        <ol>
            <li>Increment the parser's <a href="https://html.spec.whatwg.org/#script-nesting-level">script nesting level</a>.</li>

            <li>Set the <a href="https://html.spec.whatwg.org/#parser-pause-flag">parser pause flag</a> to true.</li>

            <li>If the <a href="https://tc39.github.io/ecma262/#execution-context-stack">JavaScript execution context stack</a> is empty, <a href="https://html.spec.whatwg.org/#perform-a-microtask-checkpoint">perform a microtask checkpoint</a>.</li>

            <li>Push a new <a>element queue</a> onto the <a>custom element reactions stack</a>.</li>
        </ol>
    </li>

    <li>
        <p>Let <var>element</var> be the result of <a lt="create an element">creating an element</a> given <var>document</var>, <var>localName</var>, null, <var>given namespace</var>, and <var>typeExtension</var>. If <var>will execute script</var> is true, set the <var>synchronous custom elements flag</var>; otherwise, leave it unset.</p>

        <p class="note">This will cause <a lt="custom element constructor">custom element constructors</a> to run, if <var>will execute script</var> is true. However, even if this causes <a href="https://html.spec.whatwg.org/#dom-document-write">new characters to be inserted into the tokenizer</a>, the parser will not be executed reentrantly, since the <a href="https://html.spec.whatwg.org/#parser-pause-flag">parser pause flag</a> is true. Similarly, <a href="https://html.spec.whatwg.org/#dom-document-open">blowing away the document</a> is not possible, since the <a href="https://html.spec.whatwg.org/#script-nesting-level">script nesting level</a> is greater than zero.</p>

        <p>If this step throws an exception, <a href="https://html.spec.whatwg.org/#report-the-exception">report the exception</a>, and let <var>element</var> be instead a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <a href="https://html.spec.whatwg.org/#htmlunknownelement"><code>HTMLUnknownElement</code></a>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to <var>given namespace</var>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to null, <a>defined flag</a> set, <a>custom flag</a> unset, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>..</p>
    </li>

    <li>
        <p><a href="https://dom.spec.whatwg.org/#concept-element-attributes-append">Append</a> each attribute in the given token to <var>element</var>, omitting the <code>is</code> attribute if <var>typeExtension</var> is non-null. (In that case, <a lt="create an element">creating</a> <var>element</var> will have already appended the <code>is</code> attribute.)</p>

        <p class="note">This can <a>enqueue a custom element callback reaction</a> for the <code>attributeChangedCallback</code>, which might run immediately (in the next step).</p>
    </li>

    <li>
        <p>If <var>will execute script</var> is true:</p>

        <ol>
            <li>Let <var>queue</var> be the result of popping the <a>current element queue</a> from the <a>custom element reactions stack</a>. (This will be the same <a>element queue</a> as was pushed above.)</li>

            <li><a>Invoke custom element reactions</a> in <var>queue</var>.</li>

            <li>Decrement the <a href="https://html.spec.whatwg.org/#script-nesting-level">script nesting level</a> by one.</li>

            <li>If the parser's <a href="https://html.spec.whatwg.org/#script-nesting-level">script nesting level</a> is zero, then set the <a href="https://html.spec.whatwg.org/#parser-pause-flag">parser pause flag</a> to false.</li>
        </ol>
    </li>
</ol>

</section>

<section>
<h3>HTML+: Parsing XHTML documents</h3>

<p class="monkeypatch">It turns out there's not actually a spec for the XML parser. Awesome! (Not actually awesome.) The HTML Standard has a nice vague paragraph about "This <a href="https://html.spec.whatwg.org/#document"><code>Document</code></a> must then be populated with DOM nodes that represent the tree structure of the input passed..." which should get something like the following inserted (probably by inserting it after the first sentence, then splitting the mutation events/observers prose into a new paragraph).</p>

<p>When creating DOM nodes representing elements, the <a href="https://html.spec.whatwg.org/#create-an-element-for-the-token">create an element for a token</a> algorithm or some equivalent that operates on appropriate XML datastructures must be used, to ensure the proper <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interfaces</a> are created and that <a lt="custom element">custom elements</a> are set up correctly.</p>

</section>

<section id="element-modifications-to-dom">
<h3>DOM+: Elements</h3>

<p class="monkeypatch">The <a href="https://dom.spec.whatwg.org/#interface-element"><code>Element</code> interface section</a> will need to be modified as follows. The paragraph listing the values associated with an element should be modified to read as follows, including the note afterward:</p>

<p><a href="https://dom.spec.whatwg.org/#concept-element">Elements</a> have an associated <dfn id="dfn-element-monkeypatch-namespace">namespace</dfn>, <dfn id="dfn-element-monkeypatch-namespace-prefix">namespace prefix</dfn>, <dfn id="dfn-element-monkeypatch-local-name">local name</dfn>, <dfn id="dfn-element-defined-flag">defined flag</dfn>, and <dfn id="dfn-element-custom-flag">custom flag</dfn>. When an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> is <a lt="create an element">created</a>, all of these values are initialized. An element whose <a>defined flag</a> is set is said to be <dfn id="dfn-element-defined">defined</dfn>. An element whose <a>custom flag</a> is set is said to be <dfn id="dfn-element-custom">custom</dfn>.</p>

<p class="note">
    As detailed elsewhere in this specification, all elements that are not <a>custom</a> are already <a>defined</a> upon their <a lt="create an element">creation</a>. <a>Custom</a> elements become defined once their constructor has been called, either synchronously or during the <a href="#upgrades">upgrade</a> process.
</p>

<p class="monkeypatch">Additionally, after the talk about qualified names but before the discussion of attributes, the following algorithm should be inserted:</p>

<p>To <dfn id="dfn-create-element">create an element</dfn>, given a <var>document</var>, <var>localName</var>, <var>prefix</var>, <var>namespace</var>, <var>typeExtension</var>, and an optional <var>synchronous custom elements flag</var>, run the following steps:</p>

<ol>
    <li>Let <var>registry</var> be null.</li>

    <li>If <var>document</var> has a <a href="https://html.spec.whatwg.org/#concept-document-bc">browsing context</a>, set <var>registry</var> to <var>document</var>'s <a href="https://html.spec.whatwg.org/#concept-document-window">associated <code>Window</code></a>'s <code>CustomElementsRegistry</code> object.</li>

    <li>
        <p>If <var>typeExtension</var> is not null:</p>

        <ol>
            <li>If <var>registry</var> is null, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

            <li>If <var>namespace</var> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

            <li>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>.</li>

            <li>
                <p>If <var>registry</var> is non-null, and there is an entry in <var>registry</var> with <a href="#dfn-element-definition-name">name</a> <var>typeExtension</var>, let <var>definition</var> be that entry, and perform the following subsubsteps:</p>

                <ol>
                    <li>If <var>definition</var>'s <a href="#dfn-element-definition-local-name">local name</a> is not <var>localName</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

                    <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, <a>defined flag</a> unset, <a>custom flag</a> unset, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</li>

                    <li><a href="https://dom.spec.whatwg.org/#concept-element-attributes-set-value">Set an attribute value</a> for <var>result</var> using "<code>is</code>" and <var>type</var>.</li>

                    <li><a>Enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</li>

                    <li>Return <var>result</var>.</li>
                </ol>
            </li>

            <li>
                <p>Otherwise:</p>

                <ol>
                    <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, <a>defined flag</a> unset, <a>custom flag</a> unset, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</li>

                    <li><a href="https://dom.spec.whatwg.org/#concept-element-attributes-set-value">Set an attribute value</a> for <var>result</var> using "<code>is</code>" and <var>type</var>.</li>
                </ol>
            </li>
        </ol>
    </li>

    <li>
        <p>Otherwise, if <var>registry</var> is not null, <var>namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and <var>registry</var> contains an entry with <a href="#dfn-element-definition-local-name">local name</a> <var>localName</var>, let <var>definition</var> be that entry, and perform the following substeps:</p>

        <ol>
            <li>
                <p>If <var>synchronous custom elements flag</var> is set:</p>

                <ol>
                    <li>Let <var>C</var> be <var>definition</var>'s <a href="#dfn-element-definition-constructor">constructor</a>.</li>

                    <li>Let <var>result</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>). Rethrow any exceptions.</li>

                    <li>
                        <p>If <var>result</var> does not implement the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</p>

                        <p class="note">This is meant to be a brand check to ensure that the object was allocated by the <a href="#dom-htmlelement-constructor"><code>HTMLElement</code></a> constructor. Eventually Web IDL may give us a more precise way to do brand checks.</p>
                    </li>

                    <li>If the value of <var>result</var>'s [[\Prototype]] internal slot is not equal to <var>definition</var>'s <a href="#dfn-element-definition-prototype">prototype</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

                    <li>If <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a> is not empty, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>If <var>result</var> has <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>If <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-parent">parent</a> is not null, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>If <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> is not <var>document</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>If <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>If <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> is not <var>localName</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> exception.</li>

                    <li>Set <var>result</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> to <var>prefix</var>.</li>

                    <li>Set <var>result</var>'s <a>defined flag</a> and <a>custom flag</a>.</li>

                    <li>Return <var>result</var>.</li>
                </ol>
            </li>

            <li>
                <p>Otherwise:</p>

                <ol>
                    <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, <a>defined flag</a> unset, <a>custom flag</a> unset, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set <var>document</var>.</li>

                    <li><a>Enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</li>

                    <li>Return <var>result</var>.</li>
                </ol>
            </li>
        </ol>
    </li>

    <li>
        <p>Otherwise:</p>

        <ol>
            <li>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and <var>namespace</var>.</li>

            <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to <var>namespace</var>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, <a>defined flag</a> set, <a>custom flag</a> unset, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>.</li>

            <li>If <var>registry</var> is not null, <var>namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and <var>localName</var> is a <a>valid custom element name</a>, unset <var>result</var>'s <a>defined flag</a>.</li>

            <li>Return <var>result</var>.</li>
        </ol>
    </li>
</ol>
</section>

<section id="clone-modifications-to-dom">
<h3>DOM+: Cloning</h3>

<p class="monkeypatch">The <a href="https://dom.spec.whatwg.org/#concept-node-clone">clone a node</a> algorithm will need to be modified as follows. A new case, separate from the main switch, will be needed to generate <var>copy</var> for <code>Element</code>s. It should use <a>create an element</a>, given <var>document</var>, <var>node</var>'s local name, <var>node</var>'s namespace prefix, <var>node</var>'s namespace, and the value of <var>node</var>'s <code>is</code> attribute (if present). The <var>synchronous custom elements flag</var> should be unset. The attribute copying step should also be modified to omit the <code>is</code> attribute, since that is taken care of by <a>create an element</a>.</p>

</section>

<section>
<h3>DOM+: Mutation algorithms</h3>

<p class="monkeypatch">The <a href="https://dom.spec.whatwg.org/#mutation-algorithms">mutation algorithms</a> sections need to be modified as follows to properly enqueue custom element callbacks.</p>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-node-insert">insert</a> algorithm as follows. Replace step 6.2 with:</p>

<ol start="2">
    <li>
        <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these subsubsteps:</p>

        <ol>
            <li>Run the <a href="https://dom.spec.whatwg.org/#concept-node-insert-ext">insertion steps</a> with <var>inclusiveDescendant</var> and <var>parent</var>.</li>

            <li>
              <p>If <var>inclusiveDescendant</var> was previously not <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>, but now is, then:</p>

              <ol>
                <li>If <var>inclusiveDescendant</var> is <a>custom</a>, <a>enqueue a custom element callback reaction</a> with <var>inclusiveDescendant</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</li>

                <li>
                  <p>Otherwise, <a lt="try to upgrade an element">try to upgrade</a> <var>inclusiveDescendant</var>.</p>

                  <p class="note">If this successfully upgrades <var>inclusiveDescendant</var>, its <code>connectedCallback</code> will be enqueued automatically during the <a>upgrade an element</a> algorithm.</p>
                </li>
              </ol>
            </li>
        </ol>
    </li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-node-remove">remove</a> algorithm as follows. Replace step 9 with:</p>

<ol start="9">
    <li>
        <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these subsubsteps:</p>

        <ol>
            <li>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>inclusiveDescendant</var> and <var>parent</var>.</li>

            <li>If <var>inclusiveDescendant</var> is <a>custom</a>, and was previously <a href="https://dom.spec.whatwg.org/#in-a-shadow-including-document">in a shadow-including document</a>, but now is not, <a>enqueue a custom element callback reaction</a> with <var>inclusiveDescendant</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</li>
        </ol>
    </li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change">change an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is <a>custom</a>, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-append">append an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is <a>custom</a>, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-remove">remove an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is <a>custom</a>, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-replace">replace an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is <a>custom</a>, <a>enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

</section>

<section id="extensions-to-document-interface-to-instantiate">
<h3>DOM+: <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a> methods</h3>

<p class="monkeypatch">To allow creating both <a>custom tag</a> and <a>type extension</a>-style <a data-lt="custom element">custom elements</a>, the <a href="https://dom.spec.whatwg.org/#dom-document-createelement"><code>createElement</code></a> or <a href="https://dom.spec.whatwg.org/#dom-document-createelementns"><code>createElementNS</code></a> methods gain optional <var>typeExtension</var> arguments. Their new definitions are:</p>

<pre class='idl'>
partial interface Document {
    Element createElement(DOMString localName, optional ElementCreationOptions options);
    Element createElementNS(DOMString? namespace, DOMString qualifiedName, optional ElementCreationOptions options);
};

dictionary ElementCreationOptions {
    DOMString is;
};
</pre>

<div id="monkeypatch-create-element">

The <dfn id="dom-document-createelement"><code>createElement(localName, options)</code></dfn> method, when invoked, must run these steps:

<ol>
    <li>If <var>localName</var> does not match the <a href="https://www.w3.org/TR/xml/#NT-Name"><code>Name</code></a> production, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> an <code>InvalidCharacterError</code> exception.</li>

    <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>localName</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

    <li>Let <var>typeExtension</var> be the value of the <code>is</code> member of <var>options</var>, or null if no such member exists.</li>

    <li>Return the result of <a data-lt="create an element">creating an element</a> given the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>, <var>localName</var>, null, the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <var>typeExtension</var>, and with the <var>synchronous custom elements flag</var> set. Rethrow any exceptions.</li>
</ol>

The <dfn id="dom-document-createelementns"><code>createElementNS(namespace, qualifiedName, options)</code></dfn> method, when invoked, must run these steps:

<ol>
    <li>Let <var>namespace</var>, <var>prefix</var>, and <var>localName</var> be the result of passing <var>namespace</var> and <var>qualifiedName</var> to <a href="https://dom.spec.whatwg.org/#validate-and-extract">validate and extract</a>. Rethrow any exceptions.</li>

    <li>Let <var>typeExtension</var> be the value of the <code>is</code> member of <var>options</var>, or null if no such member exists.</li>

    <li>Return the result of <a data-lt="create an element">creating an element</a> given the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>, <var>localName</var>, <var>prefix</var>, <var>namespace</var>, <var>typeExtension</var>, and with the <var>synchronous custom elements flag</var> set. Rethrow any exceptions.</li>
</ol>

</div>

</section>

</section>

<section id="appendix-a" class='appendix informative'>

<h2>Acknowledgments</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>
<p><a href="mailto:sfaulkner@paciellogroup.com">Steve Faulkner</a>, The Paciello Group, for writing the content of the section <a href="#semantics"></a>.</p>

<div itemscope itemtype="http://n.whatwg.org/work">
    <p>The &lt;flag-icon> example was inspired by <a itemprop="work" href="https://customelements.io/stevenrskelton/flag-icon/">a custom element</a> by <a itemprop="https://creativecommons.org/ns#attributionURL" href="http://stevenskelton.ca/">Steven Skelton</a>. (<a itemprop="license" href="https://opensource.org/licenses/MIT">MIT</a>)</p>
</div>

<p>The editor would also like to thank
Alex Komoroske,
Andres Rios,
Anne van Kesteren,
Boris Zbarsky,
Daniel Buchner,
Edward O'Connor,
Erik Arvidsson,
Elliott Sprehn,
Hayato Ito,
Jan Miksovsky,
Jonas Sicking,
Olli Pettay,
Rafael Weinstein,
Ryosuke Niwa,
Scott Miles,
Simon Pieters,
Steve Orvell,
Tab Atkins,
Tim Perry,
and
William Chen

for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</body>
</html>
