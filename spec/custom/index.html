<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Custom Elements</title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c-common" async="" class="remove">
</script>
  <script src="https://resources.whatwg.org/dfn.js" defer class="remove">
</script>
  <link rel="stylesheet" href="respec-complement.css">
  <script class="remove">
function resolveBacklink() {
      // For dfn.js
      if (window.initDfn) {
          initDfn();
      }
  }
  var respecConfig = {
    shortName: "custom-elements",
    specStatus: "ED",
    useExperimentalStyles: true,
    edDraftURI: "https://w3c.github.io/webcomponents/spec/custom/",
    editors: [{
       name: "Domenic Denicola",
       url: "mailto:d@domenic.me",
       company: "Google, Inc.",
       w3cid: "52873"
    }],
    wg: "Web Platform Working Group",
    wgURI: "https://www.w3.org/WebPlatform/WG/",
    wgPublicList: "public-webapps",
    subjectPrefix: "[custom-elements]",
    postProcess: [resolveBacklink],
    license: "w3c-software-doc",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/webcomponents/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/webcomponents/labels/custom-elements'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/webcomponents/commits/gh-pages/spec/custom'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-webapps@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-webapps/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use Custom Elements?',
        href: 'http://caniuse.com/#feat=custom-elementsv1'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/custom-elements/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/custom-elements'
      }]
    }],
    localBiblio:  {
      'WEBIDL': {
        title: 'Web IDL',
        href: 'https://heycam.github.io/webidl/',
        publisher: 'W3C',
        authors: [
            'Cameron McCormack',
            'Boris Zbarsky'
        ]
      },
      'MATHML': {
        title: 'Mathematical Markup Language (MathML)',
        href: 'https://www.w3.org/Math/draft-spec/',
        publisher: 'W3C',
        authors: [
          'David Carlisle',
          'Patrick Ion',
          'Robert Miner'
        ]
      },
      'SVG': {
        title: 'Scalable Vector Graphics (SVG)',
        href: 'https://www.w3.org/TR/SVG11/',
        authors: [
          'Erik Dahlström',
          'Patrick Dengler',
          'Anthony Grasso',
          'Chris Lilley',
          'Cameron McCormack',
          'Doug Schepers',
          'Jonathan Watt',
          'Jon Ferraiolo',
          '藤沢 淳 (FUJISAWA Jun)',
          'Dean Jackson'
        ]
      }
    },
    wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83482/status"
  };
  </script>
  <style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
  }
  var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
  }

  .monkeypatch {
    background: #fff9b5;
  }
  </style>
</head>

<body>
  <section id="abstract">
    <p>This specification describes the method for enabling the author to define and use new types of DOM elements in a document. It is a copy of the relevant parts of [[!HTML]] up through commit <a href="https://github.com/whatwg/html/commit/81ee034f316f4366aeb315d16ea21521c83ab427">81ee034f316f4366aeb315d16ea21521c83ab427</a> and [[!WHATWG-DOM]] through commit <a href="https://github.com/whatwg/dom/commit/cb85ac4c35baa1345f2b71e2dd3d57b098ddf2d1">cb85ac4c35baa1345f2b71e2dd3d57b098ddf2d1</a>. Section titles are prefixed with "HTML:" or "DOM:" to indicate which spec they copy from.</p>
  </section>

  <section id="sotd">
    <!-- draft specific information on status goes here -->
  </section>

  <section id="conformance">
    <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

    <p>The IDL fragments in this specification must be interpreted as required for conforming IDL fragments, as described in the Web IDL specification [[!WEBIDL]].</p>
  </section>

  <section>
    <h3 id="custom-elements">HTML: Custom elements</h3>

    <section>
      <h4 id="custom-elements-intro">Introduction</h4>

      <p><i>This section is non-normative.</i></p>

      <p><a href="#custom-element">Custom elements</a> provide a way for authors to build their own fully-featured DOM elements. Although authors could always use non-standard elements in their documents, with application-specific behaviour added after the fact by scripting or similar, such elements have historically been non-conforming and not very functional. By <a href="#element-definition">defining</a> a custom element, authors can inform the parser how to properly construct an element and how elements of that class should react to changes.</p>

      <p>Custom elements are part of a larger effort to "rationalise the platform", by explaining existing platform features (like the elements of HTML) in terms of lower-level author-exposed extensibility points (like custom element definition). Although today there are many limitations on the capabilities of custom elements—both functionally and semantically—that prevent them from fully explaining the behaviours of HTML's existing elements, we hope to shrink this gap over time.</p>

      <section>
        <h5 id="custom-elements-autonomous-example">Creating an autonomous custom element</h5>

        <p><i>This section is non-normative.</i></p>

        <p>For the purposes of illustrating how to create an <a href="#autonomous-custom-element">autonomous custom element</a>, let's define a custom element that encapsulates rendering a small icon for a country flag. Our goal is to be able to use it like so:</p>
        <pre>
&lt;flag-icon country="nl"&gt;&lt;/flag-icon&gt;
</pre>

        <p>To do this, we first declare a class for the custom element, extending <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>:</p>
        <pre>
class FlagIcon extends HTMLElement {
  constructor() {
    super();
    this._countryCode = null;
  }

  static get observedAttributes() { return ["country"]; }

  attributeChangedCallback(name, oldValue, newValue) {
    // name will always be "country" due to observedAttributes
    this._countryCode = newValue;
    this._updateRendering();
  }
  connectedCallback() {
    this._updateRendering();
  }

  get country() {
    return this._countryCode;
  }
  set country(v) {
    this.setAttribute("country", v);
  }

  _updateRendering() {
    // Left as an exercise for the reader. But, you'll probably want to
    // check this.ownerDocument.defaultView to see if we've been
    // inserted into a document with a browsing context, and avoid
    // doing any work if not.
  }
}
</pre>

        <p>We then need to use this class to define the element:</p>
        <pre>
customElements.define("flag-icon", FlagIcon);
</pre>

        <p>At this point, our above code will work! The parser, whenever it sees the <code>flag-icon</code> tag, will construct a new instance of our <code>FlagIcon</code> class, and tell our code about its new <code>country</code> attribute, which we then use to set the element's internal state and update its rendering (when appropriate).</p>

        <p>You can also create <code>flag-icon</code> elements using the DOM API:</p>
        <pre>
const flagIcon = document.createElement("flag-icon")
flagIcon.country = "jp"
document.body.appendChild(flagIcon)
</pre>

        <p>Finally, we can also use the <a href="#custom-element-constructor">custom element constructor</a> itself. That is, the above code is equivalent to:</p>
        <pre>
const flagIcon = new FlagIcon()
flagIcon.country = "jp"
document.body.appendChild(flagIcon)
</pre>
      </section>

      <section>
        <h5 id="custom-elements-customized-builtin-example">Creating a customized built-in element</h5>

        <p><i>This section is non-normative.</i></p>

        <p><a href="#customized-built-in-element">Customized built-in elements</a> are a distinct kind of <a href="#custom-element">custom element</a>, which are defined slightly differently and used very differently compared to <a href="#autonomous-custom-element">autonomous custom elements</a>. They exist to allow reuse of behaviours from the existing elements of HTML, by extending those elements with new custom functionality. This is important since many of the existing behaviours of HTML elements can unfortunately not be duplicated by using purely <a href="#autonomous-custom-element">autonomous custom elements</a>. Instead, <a href="#customized-built-in-element">customized built-in elements</a> allow the installation of custom construction behaviour, lifecycle hooks, and prototype chain onto existing elements, essentially "mixing in" these capabilities on top of the already-existing element.</p>

        <p><a href="#customized-built-in-element">Customized built-in elements</a> require a distinct syntax from <a href="#autonomous-custom-element">autonomous custom elements</a> because user agents and other software key off an element's local name in order to identify the element's semantics and behaviour. That is, the concept of <a href="#customized-built-in-element">customized built-in elements</a> building on top of existing behaviour depends crucially on the extended elements retaining their original local name.</p>

        <p>In this example, we'll be creating a <a href="#customized-built-in-element">customized built-in element</a> named <code>plastic-button</code>, which behaves like a normal button but gets fancy animation effects added whenever you click on it. We start by defining a class, just like before, although this time we extend <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> instead of <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>:</p>
        <pre>
class PlasticButton extends HTMLButtonElement {
  constructor() {
    super();

    this.addEventListener("click", () =&gt; {
      // Draw some fancy animation effects!
    });
  }
}
</pre>

        <p>When defining our custom element, we have to also specify the <code>extends</code> option:</p>
        <pre>
customElements.define("plastic-button", PlasticButton, { extends: "button" });
</pre>

        <p>In general, the name of the element being extended cannot be determined simply by looking at what element interface it extends, as many elements share the same interface (such as <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-q-element">q</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-blockquote-element">blockquote</a></code> both sharing <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmlquoteelement">HTMLQuoteElement</a></code>).</p>

        <p>To use our <a href="#customized-built-in-element">customized built-in element</a>, we use the <code><a href="#attr-is">is</a></code> attribute on a <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> element:</p>
        <pre>
&lt;button is="plastic-button"&gt;Click Me!&lt;/button&gt;
</pre>

        <p>Trying to use a <a href="#customized-built-in-element">customized built-in element</a> as an <a href="#autonomous-custom-element">autonomous custom element</a> will <em>not</em> work; that is, <code>&lt;plastic-button&gt;Click me?&lt;/plastic-button&gt;</code> will simply create an <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> with no special behaviour.</p>

        <p>If you need to create a type-extended element programmatically, you can use the following form of <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement()</a></code>:</p>
        <pre>
const plasticButton = document.createElement("button", { is: "plastic-button" });
plasticButton.textContent = "Click me!";
</pre>

        <p>And as before, the constructor will also work:</p>
        <pre>
const plasticButton2 = new PlasticButton();
console.log(plasticButton2.localName);          // will output "button"
console.log(plasticButton2.getAttribute("is")); // will output "plastic-button"
</pre>

        <p>Notably, all the of the ways in which <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> is special apply to such "plastic buttons" as well: their focus behaviour, ability to participate in <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-submit">form submission</a>, the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#attr-fe-disabled">disabled</a></code> attribute, and so on.</p>
      </section>

      <section>
        <h5 id="custom-elements-autonomous-drawbacks">Drawbacks of autonomous custom elements</h5>

        <p><i>This section is non-normative.</i></p>

        <p>As specified below, and alluded to above, simply defining and using an element called <code>taco-button</code> does not mean that such elements <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represent</a> buttons. That is, tools such as Web browsers, search engines, or accessibility technology will not automatically treat the resulting element as a button just based on its defined name.</p>

        <p>To convey the desired button semantics to a variety of users, while still using an <a href="#autonomous-custom-element">autonomous custom element</a>, a number of techniques would need to be employed:</p>

        <ul>
          <li>
            <p>The addition of the <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> attribute would make the <code>taco-button</code> <a href="https://html.spec.whatwg.org/multipage/dom.html#interactive-content-2">interactive content</a>, thus making it <a href="https://html.spec.whatwg.org/multipage/interaction.html#focusable-area">focusable</a>. Note that if the <code>taco-button</code> were to become logically disabled, the <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> attribute would need to be removed.</p>
          </li>

          <li>
            <p>The addition of various ARIA attributes helps convey semantics to accessibility technology. For example, setting the <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#attr-aria-role">role</a></code> attribute to "<code><a href="https://w3c.github.io/aria/aria/aria.html#button">button</a></code>" will convey the semantics that this is a button, enabling users to successfully interact with the control using usual button-like interactions in their accessibility technology. Setting the <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-label">aria-label</a></code> attribute is necessary to give the button an <a href="https://w3c.github.io/aria/aria/aria.html#dfn-accessible-name">accessible name</a>, instead of having accessibility technology traverse its child text nodes and announce them. And setting <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-disabled">aria-disabled</a></code> to "<code>true</code>" when the button is logically disabled conveys to accessibility technology the button's disabled state.</p>
          </li>

          <li>
            <p>The addition of event handlers to handle commonly-expected button behaviours helps convey the semantics of the button to Web browser users. In this case, the most relevant event handler would be one that proxies appropriate <code><a href="https://w3c.github.io/uievents/#event-type-keydown">keydown</a></code> events to become <code><a href="https://w3c.github.io/uievents/#event-type-click">click</a></code> events, so that you can activate the button both with keyboard and by clicking.</p>
          </li>

          <li>
            <p>In addition to any default visual styling provided for <code>taco-button</code> elements, the visual styling will also need to be updated to reflect changes in logical state, such as becoming disabled; that is, whatever stylesheet has rules for <code>taco-button</code> will also need to have rules for <code>taco-button[disabled]</code>.</p>
          </li>
        </ul>

        <p>With these points in mind, a full-featured <code>taco-button</code> that took on the responsibility of conveying button semantics (including the ability to be disabled) might look something like this:</p>
        <pre>
class TacoButton extends HTMLElement {
  static get observedAttributes() { return ["disabled"]; }

  constructor() {
    super();

    this.addEventListener("keydown", e =&gt; {
      if (e.keyCode === 32 || e.keyCode === 13) {
        this.dispatchEvent(new MouseEvent("click", {
          bubbles: true,
          cancelable: true
        }));
      }
    });

    this.addEventListener("click", e =&gt; {
      if (this.disabled) {
        e.preventDefault();
        e.stopPropagation();
      }
    });

    this._observer = new MutationObserver(() =&gt; {
      this.setAttribute("aria-label", this.textContent);
    });
  }

  connectedCallback() {
    this.setAttribute("role", "button");
    this.setAttribute("tabindex", "0");

    this._observer.observe(this, {
      childList: true,
      characterData: true,
      subtree: true
    });
  }

  disconnectedCallback() {
    this._observer.disconnect();
  }

  get disabled() {
    return this.hasAttribute("disabled");
  }

  set disabled(v) {
    if (v) {
      this.setAttribute("disabled", "");
    } else {
      this.removeAttribute("disabled");
    }
  }

  attributeChangedCallback() {
    // only is called for the disabled attribute due to observedAttributes
    if (this.disabled) {
      this.removeAttribute("tabindex");
      this.setAttribute("aria-disabled", "true");
    } else {
      this.setAttribute("tabindex", "0");
      this.setAttribute("aria-disabled", "false");
    }
  }
}
</pre>

        <p>Even with this rather-complicated element definition, the element is not a pleasure to use for consumers: it will be continually "sprouting" <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#attr-aria-*">aria-*</a></code> attributes of its own volition. This is because as of now there is no way to specify default accessibility semantics or focus behaviour for custom elements, forcing the use of these attributes to do so (even though they are usually reserved for allowing the consumer to override default behaviour).</p>

        <p>In contrast, a simple <a href="#customized-built-in-element">customized built-in element</a>, as shown in the previous section, would automatically inherit the semantics and behaviour of the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> element, with no need to implement these behaviours manually. In general, for any elements with nontrivial behaviour and semantics that build on top of existing elements of HTML, <a href="#customized-built-in-element">customized built-in elements</a> will be easier to develop, maintain, and consume.</p>
      </section>

      <section>
        <h5 id="custom-elements-upgrades-examples">Upgrading elements after their creation</h5>

        <p><i>This section is non-normative.</i></p>

        <p>Because <a href="#element-definition">element definition</a> can occur at any time, a non-custom element could be <a href="#concept-create-element">created</a>, and then later become a <a href="#custom-element">custom element</a> after an appropriate <a href="#custom-element-definition">definition</a> is registered. We call this process "upgrading" the element, from a normal element into a custom element.</p>

        <p><a href="#upgrades">Upgrades</a> enable scenarios where it may be preferable for <a href="#custom-element-definition">custom element definitions</a> to be registered after relevant elements has been initially created, such as by the parser. They allow progressive enhancement of the content in the custom element. For example, in the following HTML document the element definition for <code>img-viewer</code> is loaded asynchronously:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;title&gt;Image viewer example&lt;/title&gt;

&lt;img-viewer filter="Kelvin"&gt;
  &lt;img src="images/tree.jpg" alt="A beautiful tree towering over an empty savannah"&gt;
&lt;/img-viewer&gt;

&lt;script src="js/elements/img-viewer.js" async&gt;&lt;/script&gt;
</pre>

        <p>The definition for the <code>img-viewer</code> element here is loaded using a <code><a href="https://html.spec.whatwg.org/multipage/#the-script-element">script</a></code> element marked with the <code><a href="https://html.spec.whatwg.org/multipage/#attr-script-async">async</a></code> attribute, placed after the <code>&lt;img-viewer&gt;</code> tag in the markup. While the script is loading, the <code>img-viewer</code> element will be treated as an undefined element, similar to a <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-span-element">span</a></code>. Once the script loads, it will define the <code>img-viewer</code> element, and the existing <code>img-viewer</code> element on the page will be upgraded, applying the custom element's definition (which presumably includes applying an image filter identified by the string "Kelvin", enhancing the image's visual appearance).</p>
        <hr>

        <p>Note that <a href="#upgrades">upgrades</a> only apply to elements in the document tree. (Formally, elements that are <a href="https://dom.spec.whatwg.org/#connected">connected</a>.) An element that is not inserted into a document will stay un-upgraded. An example illustrates this point:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;title&gt;Upgrade edge-cases example&lt;/title&gt;

&lt;example-element&gt;&lt;/example-element&gt;

&lt;script&gt;
  "use strict";

  const inDocument = document.querySelector("example-element");
  const outOfDocument = document.createElement("example-element");

  // Before the element definition, both are HTMLElement:
  console.assert(inDocument instanceof HTMLElement);
  console.assert(outOfDocument instanceof HTMLElement);

  class ExampleElement extends HTMLElement {}
  customElements.define("example-element", ExampleElement);

  // After element definition, the in-document element was upgraded:
  console.assert(inDocument instanceof ExampleElement);
  console.assert(!(outOfDocument instanceof ExampleElement));

  document.body.appendChild(outOfDocument);

  // Now that we've moved the element into the document, it too was upgraded:
  console.assert(outOfDocument instanceof ExampleElement);
&lt;/script&gt;
</pre>
      </section>
    </section>

    <section>
      <h4 id="custom-element-conformance">Requirements for custom element constructors</h4>

      <p>When authoring <a href="#custom-element-constructor">custom element constructors</a>, authors are bound by the following conformance requirements:</p>

      <ul>
        <li>
          <p>A parameter-less call to <code>super()</code> must be the first statement in the constructor body, to establish the correct prototype chain and <b>this</b> value before any further code is run.</p>
        </li>

        <li>
          <p>A <code>return</code> statement must not appear anywhere inside the constructor body, unless it is a simple early-return (<code>return</code> or <code>return this</code>).</p>
        </li>

        <li>
          <p>The constructor must not use the <code><a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-write">document.write()</a></code> or <code><a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-open">document.open()</a></code> methods.</p>
        </li>

        <li>
          <p>The element's attributes and children must not be inspected, as in the non-<a href="#upgrades">upgrade</a> case none will be present, and relying on upgrades makes the element less usable.</p>
        </li>

        <li>
          <p>The element must not gain any attributes or children, as this violates the expectations of consumers who use the <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement</a></code> or <code><a href="https://dom.spec.whatwg.org/#dom-document-createelementns">createElementNS</a></code> methods.</p>
        </li>

        <li>
          <p>In general, work should be deferred to <code>connectedCallback</code> as much as possible—especially work involving fetching resources or rendering. However, note that <code>connectedCallback</code> can be called more than once, so any initialization work that is truly one-time will need a guard to prevent it from running twice.</p>
        </li>

        <li>
          <p>In general, the constructor should be used to set up initial state and default values, and to set up event listeners and possibly a <a href="https://dom.spec.whatwg.org/#concept-shadow-root">shadow root</a>.</p>
        </li>
      </ul>

      <p>Several of these requirements are checked during <a href="#concept-create-element">element creation</a>, either directly or indirectly, and failing to follow them will result in a custom element that cannot be instantiated by the parser or DOM APIs.</p>
    </section>

    <section>
      <h4 id="custom-elements-core-concepts">Core concepts</h4>

      <p>A <dfn id="custom-element">custom element</dfn> is an element that is <a href="#concept-element-custom">custom</a>. Informally, this means that its constructor and prototype are defined by the author, instead of by the user agent. This author-supplied constructor function is called the <dfn id="custom-element-constructor">custom element constructor</dfn>.</p>

      <p>Two distinct types of <a href="#custom-element">custom elements</a> can be defined:</p>

      <ol>
        <li>
          <p>An <dfn id="autonomous-custom-element">autonomous custom element</dfn>, which is defined with no <code>extends</code> option. These types of custom elements have a local name equal to their <a href="#concept-custom-element-definition-name">defined name</a>.</p>
        </li>

        <li>
          <p>A <dfn id="customized-built-in-element">customized built-in element</dfn>, which is defined with an <code>extends</code> option. These types of custom elements have local name equal to the value passed in their <code>extends</code> option, and their <a href="#concept-custom-element-definition-name">defined name</a> is used as the value of the <dfn id="attr-is"><code>is</code></dfn> attribute.</p>
        </li>
      </ol>

      <p>After a <a href="#custom-element">custom element</a> is <a href="#concept-create-element">created</a>, changing the value of the <code><a href="#attr-is">is</a></code> attribute does not change the element's behaviour, as it is saved on the element as its <a href="#concept-element-is-value"><code>is</code> value</a>.</p>

      <p><a href="#autonomous-custom-element">Autonomous custom elements</a> have the following element definition:</p>

      <dl class="element">
        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-categories">Categories</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#flow-content-2">Flow content</a>.
        </dd>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">Phrasing content</a>.
        </dd>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#palpable-content-2">Palpable content</a>.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-contexts">Contexts in which this element can be used</a>:
        </dt>

        <dd>
          Where <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">phrasing content</a> is expected.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-content-model">Content model</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#transparent">Transparent</a>.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-attributes">Content attributes</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#global-attributes">Global attributes</a>, except the <code><a href="#attr-is">is</a></code> attribute
        </dd>

        <dd>Any other attribute that has no namespace (see prose).</dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-dom">DOM interface</a>:
        </dt>

        <dd>Supplied by the element's author (inherits from <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>)</dd>
      </dl>

      <p>An <a href="#autonomous-custom-element">autonomous custom element</a> does not have any special meaning: it <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represents</a> its children. A <a href="#customized-built-in-element">customized built-in element</a> inherits the semantics of the element that it extends.</p>

      <p>Any namespace-less attribute that is relevant to the element's functioning, as determined by the element's author, may be specified on an <a href="#autonomous-custom-element">autonomous custom element</a>, so long as the attribute name is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xml-compatible">XML-compatible</a> and contains no <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#uppercase-ascii-letters">uppercase ASCII letters</a>. The exception is the <code><a href="#attr-is">is</a></code> attribute, which must not be specified on an <a href="#autonomous-custom-element">autonomous custom element</a> (and which will have no effect if it is).</p>

      <p><a href="#customized-built-in-element">Customized built-in elements</a> follow the normal requirements for attributes, based on the elements they extend. To add custom attribute-based behavior, use <code><a href="https://html.spec.whatwg.org/multipage/dom.html#attr-data-*">data-*</a></code> attributes.</p>
      <hr>

      <p>A <dfn id="valid-custom-element-name">valid custom element name</dfn> is a sequence of characters <var>name</var> that meets all of the following requirements:</p>

      <ul>
        <li>
          <p><var>name</var> must match the <code><a href="#prod-potentialcustomelementname">PotentialCustomElementName</a></code> production:</p>

          <dl>
            <dt><code><dfn id="prod-potentialcustomelementname">PotentialCustomElementName</dfn> ::=</code></dt>

            <dd><code>[a-z] (<a href="#prod-pcenchar">PCENChar</a>)* '-' (<a href="#prod-pcenchar">PCENChar</a>)*</code></dd>

            <dt><code><dfn id="prod-pcenchar">PCENChar</dfn> ::=</code></dt>

            <dd><code>"-" | "." | [0-9] | "_" | [a-z] | #xB7 | [#xC0-#xD6] | [#xD8-#xF6] | [#xF8-#x37D] | [#x37F-#x1FFF] | [#x200C-#x200D] | [#x203F-#x2040] | [#x2070-#x218F] | [#x2C00-#x2FEF] | [#x3001-#xD7FF] | [#xF900-#xFDCF] | [#xFDF0-#xFFFD] | [#x10000-#xEFFFF]</code></dd>
          </dl>

          <p>This uses the <a href="https://www.w3.org/TR/xml/#sec-notation">EBNF notation</a> from the <cite>XML</cite> specification. [[!XML]]</p>
        </li>

        <li>
          <p><var>name</var> must not be any of the following:</p>

          <ul class="brief">
            <li><code>annotation-xml</code></li>

            <li><code>color-profile</code></li>

            <li><code>font-face</code></li>

            <li><code>font-face-src</code></li>

            <li><code>font-face-uri</code></li>

            <li><code>font-face-format</code></li>

            <li><code>font-face-name</code></li>

            <li><code>missing-glyph</code></li>
          </ul>

          <p class="note">The list of names above is the summary of all hyphen-containing element names from the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">applicable specifications</a>, namely <cite>SVG</cite> and <cite>MathML</cite>. [[SVG]] [[MATHML]]</p>
        </li>
      </ul>

      <div class="note">
        <p>These requirements ensure a number of goals for <a href="#valid-custom-element-name">valid custom element names</a>:</p>

        <ul>
          <li>
            <p>They start with a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#lowercase-ascii-letters">lowercase ASCII letter</a>, ensuring that the HTML parser will treat them as tags instead of as text.</p>
          </li>

          <li>
            <p>They do not contain any <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#uppercase-ascii-letters">uppercase ASCII letters</a>, ensuring that the user agent can always treat HTML elements ASCII-case-insensitively.</p>
          </li>

          <li>
            <p>They contain a hyphen, used for namespacing and to ensure forward compatibility (since no elements will be added to HTML, SVG, or MathML with hyphen-containing local names in the future).</p>
          </li>

          <li>
            <p>They can always be created with <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement()</a></code> and <code><a href="https://dom.spec.whatwg.org/#dom-document-createelementns">createElementNS()</a></code>, which have restrictions that go beyond the parser's.</p>
          </li>
        </ul>

        <p>Apart from these restrictions, a large variety of names is allowed, to give maximum flexibility for use cases like <code>&lt;math-α&gt;</code> or <code>&lt;emotion-😍&gt;</code>.</p>
      </div>

      <p>A <dfn id="custom-element-definition">custom element definition</dfn> describes a <a href="#custom-element">custom element</a> and consists of:</p>

      <dl>
        <dt>A <dfn id="concept-custom-element-definition-name">name</dfn></dt>

        <dd>
          A <a href="#valid-custom-element-name">valid custom element name</a>
        </dd>

        <dt>A <dfn id="concept-custom-element-definition-local-name">local name</dfn></dt>

        <dd>A local name</dd>

        <dt>A <dfn id="concept-custom-element-definition-constructor">constructor</dfn></dt>

        <dd>
          A <a href="#custom-element-constructor">custom element constructor</a>
        </dd>

        <dt>A <dfn id="concept-custom-element-definition-prototype">prototype</dfn></dt>

        <dd>A JavaScript object</dd>

        <dt>A list of <dfn id="concept-custom-element-definition-observed-attributes">observed attributes</dfn></dt>

        <dd>A <code>sequence&lt;DOMString&gt;</code></dd>

        <dt>A collection of <dfn id="concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</dfn></dt>

        <dd>A map, whose four keys are the strings "<code>connectedCallback</code>", "<code>disconnectedCallback</code>", "<code>adoptedCallback</code>", and "<code>attributeChangedCallback</code>". The corresponding values are either a Web IDL <code><a href="https://heycam.github.io/webidl/#common-Function">Function</a></code> callback function type value, or null. By default the value of each entry is null.</dd>

        <dt>A <dfn id="concept-custom-element-definition-construction-stack">construction stack</dfn></dt>

        <dd>
          A list, initially empty, that is manipulated by the <a href="#concept-upgrade-an-element">upgrade an element</a> algorithm and the <a href="#html-element-constructors">HTML element constructors</a>. Each entry in the list will be either an element or an <dfn id="concept-already-constructed-marker"><i>already constructed</i> marker</dfn>.
        </dd>
      </dl>

      <p>To <dfn id="look-up-a-custom-element-definition">look up a custom element definition</dfn>, given a <var>document</var>, <var>namespace</var>, <var>localName</var>, and <var>is</var>, perform the following steps. They will return either a <a href="#custom-element-definition">custom element definition</a> or null:</p>

      <ol>
        <li>
          <p>If <var>namespace</var> is not the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a>, return null.</p>
        </li>

        <li>
          <p>If <var>document</var> does not have a <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc">browsing context</a>, return null.</p>
        </li>

        <li>
          <p>Let <var>registry</var> be <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc">browsing context</a>'s <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code>'s <code><a href="#customelementregistry">CustomElementRegistry</a></code> object.</p>
        </li>

        <li>
          <p>If there is <a href="#custom-element-definition">custom element definition</a> in <var>registry</var> with <a href="#concept-custom-element-definition-name">name</a> and <a href="#concept-custom-element-definition-local-name">local name</a> both equal to <var>localName</var>, return that <a href="#custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>If there is a <a href="#custom-element-definition">custom element definition</a> in <var>registry</var> with <a href="#concept-custom-element-definition-name">name</a> equal to <var>is</var> and <a href="#concept-custom-element-definition-local-name">local name</a> equal to <var>localName</var>, return that <a href="#custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>Return null.</p>
        </li>
      </ol>
    </section>

    <section>
      <h4 id="custom-elements-api">The CustomElementRegistry interface</h4>

      <p>Each <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object is associated with a unique instance of a <code><a href="#customelementregistry">CustomElementRegistry</a></code> object, allocated when the <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object is created.</p>

      <p class="note">Custom element registries are associated with <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> objects, instead of <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> objects, since each <a href="#custom-element-constructor">custom element constructor</a> inherits from the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, and there is exactly one <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface per <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object.</p>

      <p>The <dfn id="dom-window-customelements"><code>customElements</code></dfn> attribute of the <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> interface must return the <code><a href="#customelementregistry">CustomElementRegistry</a></code> object for that <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object.</p>
      <pre class="idl">
interface <dfn id="customelementregistry">CustomElementRegistry</dfn> {
  [<a href="#cereactions">CEReactions</a>] void <a href="#dom-customelementregistry-define">define</a>(DOMString name, Function constructor, optional ElementDefinitionOptions options);
  any <a href="#dom-customelementregistry-get">get</a>(DOMString name);
  Promise&lt;void&gt; <a href="#dom-customelementregistry-whendefined">whenDefined</a>(DOMString name);
};

dictionary <dfn id="elementdefinitionoptions">ElementDefinitionOptions</dfn> {
  DOMString extends;
};
</pre>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> has a set of <a href="#custom-element-definition">custom element definitions</a>, initially empty. In general, algorithms in this specification look up elements in the registry by any of <a href="#concept-custom-element-definition-name">name</a>, <a href="#concept-custom-element-definition-local-name">local name</a>, or <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> also has an <dfn id="element-definition-is-running">element definition is running</dfn> flag which is used to prevent reentrant invocations of <a href="#element-definition">element definition</a>. It is initially unset.</p>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> also has a <dfn id="when-defined-promise-map">when-defined promise map</dfn>, mapping <a href="#valid-custom-element-name">valid custom element names</a> to promises. It is used to implement the <code><a href="#dom-customelementregistry-whendefined">whenDefined()</a></code> method.</p>

      <dl class="domintro note">
        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-define">define</a></code>(<var>name</var>, <var>constructor</var>)</dt>

        <dd>
          Defines a new <a href="#custom-element">custom element</a>, mapping the given name to the given constructor as an <a href="#autonomous-custom-element">autonomous custom element</a>.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-define">define</a></code>(<var>name</var>, <var>constructor</var>, { extends: <var>baseLocalName</var> })</dt>

        <dd>
          Defines a new <a href="#custom-element">custom element</a>, mapping the given name to the given constructor as a <a href="#customized-built-in-element">customized built-in element</a> for the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#element-type">element type</a> identified by the supplied <var>baseLocalName</var>. A <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> will be thrown upon trying to extend a <a href="#custom-element">custom element</a> or an unknown element.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-get">get</a></code>(<var>name</var>)</dt>

        <dd>
          Retrieves the <a href="#custom-element-constructor">custom element constructor</a> defined for the given <a href="#concept-custom-element-definition-name">name</a>. Returns undefined if there is no <a href="#custom-element-definition">custom element definition</a> with the given <a href="#concept-custom-element-definition-name">name</a>.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-whendefined">whenDefined</a></code>(<var>name</var>)</dt>

        <dd>
          Returns a promise that will be fulfilled when a <a href="#custom-element">custom element</a> becomes defined with the given name. (If such a <a href="#custom-element">custom element</a> is already defined, the returned promise will be immediately fulfilled.) Returns a promise rejected with a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> if not given a <a href="#valid-custom-element-name">valid custom element name</a>.
        </dd>
      </dl>

      <p><dfn id="element-definition">Element definition</dfn> is a process of adding a <a href="#custom-element-definition">custom element definition</a> to the <code><a href="#customelementregistry">CustomElementRegistry</a></code>. This is accomplished by the <code><a href="#dom-customelementregistry-define">define()</a></code> method. When invoked, the <dfn id="dom-customelementregistry-define"><code>define(<var>name</var>, <var>constructor</var>, <var>options</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If <a href="https://tc39.github.io/ecma262/#sec-isconstructor">IsConstructor</a>(<var>constructor</var>) is false, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If <var>name</var> is not a <a href="#valid-custom-element-name">valid custom element name</a>, then throw a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-constructor">constructor</a> <var>constructor</var>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>Let <var>localName</var> be <var>name</var>.</p>
        </li>

        <li>
          <p>Let <var>extends</var> be the value of the <code>extends</code> member of <var>options</var>, or null if no such member exists.</p>
        </li>

        <li>
          <p>If <var>extends</var> is not null, then:</p>

          <ol>
            <li>
              <p>If <var>extends</var> is a <a href="#valid-custom-element-name">valid custom element name</a>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code>.</p>
            </li>

            <li>
              <p>If the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>extends</var> and the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a> is <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement">HTMLUnknownElement</a></code> (e.g., if <var>extends</var> does not indicate an element definition in this specification), then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code>.</p>
            </li>

            <li>
              <p>Set <var>localName</var> to <var>extends</var>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag is set, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>Set this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag.</p>
        </li>

        <li>
          <p>Run the following substeps while catching any exceptions:</p>

          <ol>
            <li>
              <p>Let <var>prototype</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "prototype"). Rethrow any exceptions.</p>
            </li>

            <li>
              <p>If <a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a>(<var>prototype</var>) is not Object, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> exception.</p>
            </li>

            <li>
              <p>Let <var>lifecycleCallbacks</var> be a map with the four keys "<code>connectedCallback</code>", "<code>disconnectedCallback</code>", "<code>adoptedCallback</code>", and "<code>attributeChangedCallback</code>", each of which belongs to an entry whose value is null.</p>
            </li>

            <li>
              <p>For each of the four keys <var>callbackName</var> in <var>lifecycleCallbacks</var>, in the order listed in the previous step:</p>

              <ol>
                <li>
                  <p>Let <var>callbackValue</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, <var>callbackName</var>). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>callbackValue</var> is not undefined, then set the value of the entry in <var>lifecycleCallbacks</var> with key <var>callbackName</var> to the result of <a href="https://heycam.github.io/webidl/#es-type-mapping">converting</a> <var>callbackValue</var> to the Web IDL <code><a href="https://heycam.github.io/webidl/#common-Function">Function</a></code> callback type. Rethrow any exceptions from the conversion.</p>
                </li>
              </ol>
            </li>

            <li>
              <p>Let <var>observedAttributes</var> be an empty <code>sequence&lt;DOMString&gt;</code>.</p>
            </li>

            <li>
              <p>If the value of the entry in <var>lifecycleCallbacks</var> with key "<code>attributeChangedCallback</code>" is not null, then:</p>

              <ol>
                <li>
                  <p>Let <var>observedAttributesIterable</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "observedAttributes"). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>observedAttributesIterable</var> is not undefined, then set <var>observedAttributes</var> to the result of <a href="https://heycam.github.io/webidl/#es-type-mapping">converting</a> <var>observedAttributesIterable</var> to a <code>sequence&lt;DOMString&gt;</code>. Rethrow any exceptions from the conversion.</p>
                </li>
              </ol>
            </li>
          </ol>

          <p>Then, perform the following substep, regardless of whether the above steps threw an exception or not:</p>

          <ol>
            <li>
              <p>Unset this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag.</p>
            </li>
          </ol>

          <p>Finally, if the first set of substeps threw an exception, then rethrow that exception, and terminate this algorithm. Otherwise, continue onward.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be a new <a href="#custom-element-definition">custom element definition</a> with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, <a href="#concept-custom-element-definition-local-name">local name</a> <var>localName</var>, <a href="#concept-custom-element-definition-constructor">constructor</a> <var>constructor</var>, <a href="#concept-custom-element-definition-prototype">prototype</a> <var>prototype</var>, <a href="#concept-custom-element-definition-observed-attributes">observed attributes</a> <var>observedAttributes</var>, and <a href="#concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</a> <var>lifecycleCallbacks</var>.</p>
        </li>

        <li>
          <p>Add <var>definition</var> to this <code><a href="#customelementregistry">CustomElementRegistry</a></code>.</p>
        </li>

        <li>
          <p>Let <var>document</var> be this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global">relevant global object</a>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-window">associated <code>Document</code></a>.</p>
        </li>

        <li>
          <p>Let <var>upgrade candidates</var> be all elements that are <a href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant">shadow-including descendants</a> of <var>document</var>, whose namespace is the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a> and whose local name is <var>localName</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>. Additionally, if <var>extends</var> is non-null, only include elements whose <a href="#concept-element-is-value"><code>is</code> value</a> is equal to <var>name</var>.</p>
        </li>

        <li>
          <p>For each element <var>element</var> in <var>upgrade candidates</var>, <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>element</var> and <var>definition</var>.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a> contains an entry with key <var>name</var>:</p>

          <ol>
            <li>
              <p>Let <var>promise</var> be the value of that entry.</p>
            </li>

            <li>
              <p>Resolve <var>promise</var> with undefined.</p>
            </li>

            <li>
              <p>Delete the entry with key <var>name</var> from this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a>.</p>
            </li>
          </ol>
        </li>
      </ol>

      <p>When invoked, the <dfn id="dom-customelementregistry-get"><code>get(<var>name</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then return that entry's <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
        </li>

        <li>
          <p>Otherwise, return undefined.</p>
        </li>
      </ol>

      <p>When invoked, the <dfn id="dom-customelementregistry-whendefined"><code>whenDefined(<var>name</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If <var>name</var> is not a <a href="#valid-custom-element-name">valid custom element name</a>, then return a new promise rejected with a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then return a new promise resolved with undefined and abort these steps.</p>
        </li>

        <li>
          <p>Let <var>map</var> be this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a>.</p>
        </li>

        <li>
          <p>If <var>map</var> does not contain an entry with key <var>name</var>, create an entry in <var>map</var> with key <var>name</var> and whose value is a new promise.</p>
        </li>

        <li>
          <p>Let <var>promise</var> be the value of the entry in <var>map</var> with key <var>name</var>.</p>
        </li>

        <li>
          <p>Return <var>promise</var>.</p>
        </li>
      </ol>

      <div class="example">
        <p>The <code><a href="#dom-customelementregistry-whendefined">whenDefined()</a></code> method can be used to avoid performing an action until all appropriate <a href="#custom-element">custom elements</a> are <a href="#concept-element-defined">defined</a>. In this example, we combine it with the <code><a href="#selector-defined">:defined</a></code> pseudo-class to hide a dynamically-loaded article's contents until we're sure that all of the <a href="#autonomous-custom-element">autonomous custom elements</a> it uses are defined.</p>
        <pre>
articleContainer.hidden = true;

fetch(articleURL)
  .then(response =&gt; response.text())
  .then(text =&gt; {
    articleContainer.innerHTML = text;

    return Promise.all(
      [...articleContainer.querySelectorAll(":not(:defined)")]
        .map(el =&gt; customElements.whenDefined(el.localName))
    );
  })
  .then(() =&gt; {
    articleContainer.hidden = false;
  });
</pre>
      </div>
    </section>

    <section>
      <h4 id="upgrades">Upgrades</h4>

      <p>To <dfn id="concept-upgrade-an-element">upgrade an element</dfn>, given as input a <a href="#custom-element-definition">custom element definition</a> <var>definition</var> and an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>If <var>element</var> is <a href="#concept-element-custom">custom</a>, abort these steps.</p>

          <div class="example">
            <p>This can occur due to reentrant invocation of this algorithm, as in the following example:</p>
            <pre>
&lt;!DOCTYPE html&gt;
&lt;x-foo id="a"&gt;&lt;/x-foo&gt;
&lt;x-foo id="b"&gt;&lt;/x-foo&gt;

&lt;script&gt;
// Defining enqueues upgrade reactions for both "a" and "b"
customElements.define("x-foo", class extends HTMLElement {
  constructor() {
    super();

    const b = document.querySelector("#b");
    b.remove();

    // While this constructor is running for "a", "b" is still
    // undefined, and so inserting it into the document will enqueue a
    // second upgrade reaction for "b" in addition to the one enqueued
    // by defining x-foo.
    document.body.appendChild(b);
  }
})
&lt;/script&gt;
</pre>

            <p>This step will thus bail out the algorithm early when <a href="#concept-upgrade-an-element">upgrade an element</a> is invoked with "<code>b</code>" a second time.</p>
          </div>
        </li>

        <li>
          <p>If <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> is "<code>failed</code>", then abort these steps.</p>
        </li>

        <li>
          <p>For each <var>attribute</var> in <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>, in order, <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s local name, null, <var>attribute</var>'s value, and <var>attribute</var>'s namespace.</p>
        </li>

        <li>
          <p>If <var>element</var> is <a href="https://dom.spec.whatwg.org/#connected">connected</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</p>
        </li>

        <li>
          <p>Add <var>element</var> to the end of <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>
        </li>

        <li>
          <p>Let <var>C</var> be <var>definition</var>'s <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
        </li>

        <li>
          <p>Let <var>constructResult</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>).</p>

          <p class="note">If <var>C</var> <a href="#custom-element-conformance">non-conformantly</a> uses an API decorated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute, then the reactions enqueued at the beginning of this algorithm will execute during this step, before <var>C</var> finishes and control returns to this algorithm. Otherwise, they will execute after <var>C</var> and the rest of the upgrade process finishes.</p>
        </li>

        <li>
          <p>Remove the last entry from the end of <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>

          <div class="note">
            <p>Assuming <var>C</var> calls <code>super()</code> (as it will if it is <a href="#custom-element-conformance">conformant</a>), and that the call succeeds, this will be the <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a> that replaced the <var>element</var> we pushed at the beginning of this algorithm. (The <a href="#html-element-constructors">HTML element constructor</a> carries out this replacement.)</p>

            <p>If <var>C</var> does not call <code>super()</code> (i.e. it is not <a href="#custom-element-conformance">conformant</a>), or if any step in the <a href="#html-element-constructors">HTML element constructor</a> throws, then this entry will still be <var>element</var>.</p>
          </div>
        </li>

        <li>
          <p>If <var>constructResult</var> is an abrupt completion, then:</p>

          <ol>
            <li>
              <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>failed</code>".</p>
            </li>

            <li>
              <p>Return <var>constructResult</var> (i.e., rethrow the exception), and terminate these steps.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If <a href="https://tc39.github.io/ecma262/#sec-samevalue">SameValue</a>(<var>constructResult</var>.[[\value]], <var>element</var>) is false, then throw an <a href="https://heycam.github.io/webidl/#invalidstateerror">"<code>InvalidStateError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and terminate these steps.</p>

          <p class="note">This can occur if <var>C</var> constructs another instance of the same custom element before calling <code>super()</code>, or if <var>C</var> uses JavaScript's <code>return</code>-override feature to return an arbitrary object from the constructor.</p>
        </li>

        <li>
          <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>custom</code>".</p>
        </li>

        <li>
          <p>Set <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a> to <var>definition</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="concept-try-upgrade">try to upgrade an element</dfn>, given as input an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>, <var>element</var>'s namespace, <var>element</var>'s local name, and <var>element</var>'s <a href="#concept-element-is-value"><code>is</code> value</a>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is not null, then <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>element</var> and <var>definition</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h4 id="custom-element-reactions">Custom element reactions</h4>

      <p>A <a href="#custom-element">custom element</a> possesses the ability to respond to certain occurrences by running author code:</p>

      <ul>
        <li>
          <p>When <a href="#upgrades">upgraded</a>, its <a href="#custom-element-constructor">constructor</a> is run.</p>
        </li>

        <li>
          <p>When it <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-connected">becomes connected</a>, its <code>connectedCallback</code> is run.</p>
        </li>

        <li>
          <p>When it <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-disconnected">becomes disconnected</a>, its <code>disconnectedCallback</code> is run.</p>
        </li>

        <li>
          <p>When it is <a href="https://dom.spec.whatwg.org/#concept-node-adopt">adopted</a> into a new document, its <code>adoptedCallback</code> is run.</p>
        </li>

        <li>
          <p>When any of its attributes are <a href="#concept-element-attributes-change">changed</a>, <a href="#concept-element-attributes-append">appended</a>, <a href="#concept-element-attributes-remove">removed</a>, or <a href="#concept-element-attributes-replace">replaced</a>, its <code>attributeChangedCallback</code> is run.</p>
        </li>
      </ul>

      <p>We call these reactions collectively <dfn id="concept-custom-element-reaction">custom element reactions</dfn>.</p>

      <p>The way in which <a href="#concept-custom-element-reaction">custom element reactions</a> are invoked is done with special care, to avoid running author code during the middle of delicate operations. Effectively, they are delayed until "just before returning to user script". This means that for most purposes they appear to execute synchronously, but in the case of complicated composite operations (like <a href="#concept-node-clone">cloning</a>, or <a href="https://dom.spec.whatwg.org/#concept-range">range</a> manipulation), they will instead be delayed until after all the relevant user agent processing steps have completed, and then run together as a batch.</p>

      <p>Additionally, the precise ordering of these reactions is managed via a somewhat-complicated stack-of-queues system, described below. The intention behind this system is to guarantee that <a href="#concept-custom-element-reaction">custom element reactions</a> always are invoked in the same order as their triggering actions, at least within the local context of a single <a href="#custom-element">custom element</a>. (Because <a href="#concept-custom-element-reaction">custom element reaction</a> code can perform its own mutations, it is not possible to give a global ordering guarantee across multiple elements.)</p>
      <hr>

      <p>Each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has a <dfn id="custom-element-reactions-stack">custom element reactions stack</dfn>, which is initially empty. The <dfn id="current-element-queue">current element queue</dfn> is the <a href="#element-queue">element queue</a> at the top of the <a href="#custom-element-reactions-stack">custom element reactions stack</a>. Each item in the stack is an <dfn id="element-queue">element queue</dfn>, which is initially empty as well. Each item in an <a href="#element-queue">element queue</a> is an element. (The elements are not necessarily <a href="#concept-element-custom">custom</a> yet, since this queue is used for <a href="#upgrades">upgrades</a> as well.)</p>

      <p>Each <a href="#custom-element-reactions-stack">custom element reactions stack</a> has an associated <dfn id="backup-element-queue">backup element queue</dfn>, which an initially-empty <a href="#element-queue">element queue</a>. Elements are pushed onto the <a href="#backup-element-queue">backup element queue</a> during operations that affect the DOM without going through an API decorated with <code><a href="#cereactions">[CEReactions]</a></code>, or through the parser's <a href="#create-an-element-for-the-token">create an element for the token</a> algorithm. An example of this is a user-initiated editing operation which modifies the descendants or attributes of an <a href="https://w3c.github.io/editing/execCommand.html#editable">editable</a> element. To prevent reentrancy when processing the <a href="#backup-element-queue">backup element queue</a>, each <a href="#custom-element-reactions-stack">custom element reactions stack</a> also has a <dfn id="processing-the-backup-element-queue">processing the backup element queue</dfn> flag, initially unset.</p>

      <p>All elements have an associated <dfn id="custom-element-reaction-queue">custom element reaction queue</dfn>, initially empty. Each item in the <a href="#custom-element-reaction-queue">custom element reaction queue</a> is of one of two types:</p>

      <ul>
        <li>
          <p>An <dfn id="upgrade-reaction">upgrade reaction</dfn>, which will <a href="#upgrades">upgrade</a> the custom element and contains a <a href="#custom-element-definition">custom element definition</a>; or</p>
        </li>

        <li>
          <p>A <dfn id="callback-reaction">callback reaction</dfn>, which will call a lifecycle callback, and contains a callback function as well as a list of arguments.</p>
        </li>
      </ul>

      <p>This is all summarised in the following schematic diagram:</p>

      <p><img src="custom-element-reactions.svg" alt="A custom element reactions stack consists of a stack of element queues. Zooming in on a particular queue, we see that it contains a number of elements (in our example, &lt;x-a&gt;, then &lt;x-b&gt;, then &lt;x-c&gt;). Any particular element in the queue then has a custom element reaction queue. Zooming in on the custom element reaction queue, we see that it contains a variety of queued-up reactions (in our example, upgrade, then attribute changed, then another attribute changed, then connected)." style="width: 80%; max-width: 580px;"></p>

      <p>To <dfn id="enqueue-an-element-on-the-appropriate-element-queue">enqueue an element on the appropriate element queue</dfn>, given an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>If the <a href="#custom-element-reactions-stack">custom element reactions stack</a> is empty, then:</p>

          <ol>
            <li>
              <p>Add <var>element</var> to the <a href="#backup-element-queue">backup element queue</a>.</p>
            </li>

            <li>
              <p>If the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag is set, abort this algorithm.</p>
            </li>

            <li>
              <p>Set the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag.</p>
            </li>

            <li>
              <p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask">Queue a microtask</a> to perform the following steps:</p>

              <ol>
                <li>
                  <p><a href="#invoke-custom-element-reactions">Invoke custom element reactions</a> in the <a href="#backup-element-queue">backup element queue</a>.</p>
                </li>

                <li>
                  <p>Unset the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, add <var>element</var> to the <a href="#current-element-queue">current element queue</a>.</p>
        </li>
      </ol>

      <p>To <dfn id="enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</dfn>, given a <a href="#custom-element">custom element</a> <var>element</var>, a callback name <var>callbackName</var>, and a list of arguments <var>args</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>definition</var> be <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>Let <var>callback</var> be the value of the entry in <var>definition</var>'s <a href="#concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</a> with key <var>callbackName</var>.</p>
        </li>

        <li>
          <p>If <var>callback</var> is null, then abort these steps.</p>
        </li>

        <li>
          <p>If <var>callbackName</var> is "<code>attributeChangedCallback</code>", then:</p>

          <ol>
            <li>
              <p>Let <var>attributeName</var> be the first element of <var>args</var>.</p>
            </li>

            <li>
              <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-observed-attributes">observed attributes</a> does not contain <var>attributeName</var>, then abort these steps.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Add a new <a href="#callback-reaction">callback reaction</a> to <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>, with callback function <var>callback</var> and arguments <var>args</var>.</p>
        </li>

        <li>
          <p><a href="#enqueue-an-element-on-the-appropriate-element-queue">Enqueue an element on the appropriate element queue</a> given <var>element</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</dfn>, given an element <var>element</var> and <a href="#custom-element-definition">custom element definition</a> <var>definition</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Add a new <a href="#upgrade-reaction">upgrade reaction</a> to <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>, with <a href="#custom-element-definition">custom element definition</a> <var>definition</var>.</p>
        </li>

        <li>
          <p><a href="#enqueue-an-element-on-the-appropriate-element-queue">Enqueue an element on the appropriate element queue</a> given <var>element</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="invoke-custom-element-reactions">invoke custom element reactions</dfn> in an <a href="#element-queue">element queue</a> <var>queue</var>, run the following steps:</p>

      <ol>
        <li>
          <p>For each <a href="#custom-element">custom element</a> <var>element</var> in <var>queue</var>:</p>

          <ol>
            <li>
              <p>Let <var>reactions</var> be <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>.</p>
            </li>

            <li>
              <p>Repeat until <var>reactions</var> is empty:</p>

              <ol>
                <li>
                  <p>Remove the first element of <var>reactions</var>, and let <var>reaction</var> be that element. Switch on <var>reaction</var>'s type:</p>

                  <dl class="switch">
                    <dt>
                      <a href="#upgrade-reaction">upgrade reaction</a>
                    </dt>

                    <dd>
                      <a href="#concept-upgrade-an-element">Upgrade</a> <var>element</var> using <var>reaction</var>'s <a href="#custom-element-definition">custom element definition</a>.
                    </dd>

                    <dt>
                      <a href="#callback-reaction">callback reaction</a>
                    </dt>

                    <dd>
                      <a href="https://heycam.github.io/webidl/#es-invoking-callback-functions">Invoke</a> <var>reaction</var>'s callback function with <var>reaction</var>'s arguments, and with <var>element</var> as the <a href="https://heycam.github.io/webidl/#dfn-callback-this-value">callback this value</a>.
                    </dd>
                  </dl>

                  <p>If this throws any exception, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
      <hr>

      <p>To ensure <a href="#concept-custom-element-reaction">custom element reactions</a> are triggered appropriately, we introduce the <dfn id="cereactions"><code>[CEReactions]</code></dfn> IDL <a href="https://heycam.github.io/webidl/#dfn-extended-attribute">extended attribute</a>. It indicates that the relevant algorithm is to be supplemented with additional steps in order to appropriately track and invoke <a href="#concept-custom-element-reaction">custom element reactions</a>.</p>

      <p>The <code><a href="#cereactions">[CEReactions]</a></code> extended attribute must take no arguments, and must not appear on anything other than an operation, attribute, setter, or deleter. Additionally, it must not appear on readonly attributes, unless the readonly attribute is also annotated with <code>[PutForwards]</code>.</p>

      <p>Operations, attributes, setters, or deleters annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute must run the following steps surrounding the main algorithm specified for the operation, setter, deleter, or for the attribute's setter:</p>

      <dl>
        <dt>Before executing the algorithm's steps</dt>

        <dd>
          Push a new <a href="#element-queue">element queue</a> onto the <a href="#custom-element-reactions-stack">custom element reactions stack</a>.
        </dd>

        <dt>After executing the algorithm's steps</dt>

        <dd>
          Pop the <a href="#element-queue">element queue</a> from the <a href="#custom-element-reactions-stack">custom element reactions stack</a>, and <a href="#invoke-custom-element-reactions">invoke custom element reactions</a> in that queue.
        </dd>
      </dl>

      <div class="note">
        <p>The intent behind this extended attribute is somewhat subtle. One way of accomplishing its goals would be to say that every operation, attribute, setter, and deleter on the platform should have these steps inserted, and to allow implementers to optimize away unnecessary cases (where no DOM mutation is possible that could cause <a href="#concept-custom-element-reaction">custom element reactions</a> to occur).</p>

        <p>However, in practice this imprecision could lead to non-interoperable implementations of <a href="#concept-custom-element-reaction">custom element reactions</a>, as some implementations might forget to invoke these steps in some cases. Instead, we settled on the approach of explicitly annotating all relevant IDL constructs, as a way of ensuring interoperable behavior and helping implementations easily pinpoint all cases where these steps are necessary.</p>
      </div>

      <p>Any nonstandard APIs introduced by the user agent that could modify the DOM in such a way as to cause <a href="#enqueue-a-custom-element-callback-reaction">enqueuing a custom element callback reaction</a> or <a href="#enqueue-a-custom-element-upgrade-reaction">enqueuing a custom element upgrade reaction</a>, for example by modifying any attributes or child elements, must also be decorated with the <code><a href="#cereactions">[CEReactions]</a></code> attribute.</p>

      <div class="note">
        <p>As of the time of this writing, the following nonstandard or not-yet-standardized APIs are known to fall into this category:</p>

        <ul>
          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>'s <code>outerText</code> IDL attribute</p>
          </li>

          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlinputelement">HTMLInputElement</a></code>'s <code>webkitdirectory</code> and <code>incremental</code> IDL attributes</p>
          </li>

          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a></code>'s <code>disabled</code> and <code>scope</code> IDL attributes</p>
          </li>

          <li>
            <p><code><a href="https://dom.spec.whatwg.org/#interface-shadowroot">ShadowRoot</a></code>'s <code>innerHTML</code> IDL attribute</p>
          </li>
        </ul>
      </div>
    </section>
  </section>

  <section>
    <h4 id="html-element-constructors">HTML: HTML element constructors</h4>

    <p>To support the <a href="#custom-elements">custom elements</a> feature, all HTML elements have special constructor behavior. This is indicated via the <dfn id="htmlconstructor"><code>[HTMLConstructor]</code></dfn> IDL <a href="https://heycam.github.io/webidl/#dfn-extended-attribute">extended attribute</a>. It indicates that the interface object for the given interface will have a specific behavior when called, as defined in detail below.</p>

    <p>The <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute must take no arguments, and must not appear on anything other than an interface. It must appear only once on an interface, and the interface must not be annotated with the <code>[Constructor]</code> or <code>[NoInterfaceObject]</code> extended attributes. (However, the interface may be annotated with <code>[NamedConstructor]</code>; there is no conflict there.) It must not be used on a callback interface.</p>

    <p><a href="https://heycam.github.io/webidl/#dfn-interface-object">Interface objects</a> for interfaces annotated with the <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute must run the following steps as the function body behavior for both [[\Call]] and [[\Construct]] invocations of the corresponding JavaScript function object. When invoked with [[\Call]], the NewTarget value is undefined, and so the algorithm below will immediately throw. When invoked with [[\Construct]], the [[\Construct]] <var>newTarget</var> parameter provides the NewTarget value.</p>

    <ol>
      <li>
        <p>Let <var>registry</var> be the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object">current global object</a>'s <code><a href="#customelementregistry">CustomElementRegistry</a></code> object.</p>
      </li>

      <li>
        <p>If NewTarget is equal to the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

        <div class="example no-backref">
          <p>This can occur when a custom element is defined using an <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> as its constructor:</p>
          <pre>
customElements.define("bad-1", HTMLButtonElement);
new HTMLButtonElement();          // (1)
document.createElement("bad-1");  // (2)
</pre>

          <p>In this case, during the execution of <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> (either explicitly, as in (1), or implicitly, as in (2)), both the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> and NewTarget are <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code>. If this check was not present, it would be possible to create an instance of <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> whose local name was <code>bad-1</code>.</p>
        </div>
      </li>

      <li>
        <p>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#concept-custom-element-definition-constructor">constructor</a> equal to NewTarget. If there is no such definition, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

        <p class="note">Since there can be no entry in <var>registry</var> with a <a href="#concept-custom-element-definition-constructor">constructor</a> of undefined, this step also prevents HTML element constructors from being called as functions (since in that case NewTarget will be undefined).</p>
      </li>

      <li>
        <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a> is equal to <var>definition</var>'s <a href="#concept-custom-element-definition-name">name</a> (i.e., <var>definition</var> is for an <a href="#autonomous-custom-element">autonomous custom element</a>), then:</p>

        <ol>
          <li>
            <p>If the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> is not <code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

            <div class="example no-backref">
              <p>This can occur when a custom element is defined to not extend any local names, but inherits from a non-<code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code> class:</p>
              <pre>
customElements.define("bad-2", class Bad2 extends HTMLParagraphElement {});
</pre>

              <p>In this case, during the (implicit) <code>super()</code> call that occurs when constructing an instance of <code>Bad2</code>, the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> is <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmlparagraphelement">HTMLParagraphElement</a></code>, not <code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code>.</p>
            </div>
          </li>
        </ol>
      </li>

      <li>
        <p>Otherwise (i.e., if <var>definition</var> is for a <a href="#customized-built-in-element">customized built-in element</a>):</p>

        <ol>
          <li>
            <p>Let <var>valid local names</var> be the list of local names for elements defined in this specification or in <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">other applicable specifications</a> that use the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> as their <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a>.</p>
          </li>

          <li>
            <p>If <var>valid local names</var> does not contain <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

            <div class="example no-backref">
              <p>This can occur when a custom element is defined to extend a given local name but inherits from the wrong class:</p>
              <pre>
customElements.define("bad-3", class Bad3 extends HTMLQuoteElement {}, { extends: "p" });
</pre>

              <p>In this case, during the (implicit) <code>super()</code> call that occurs when constructing an instance of <code>Bad3</code>, <var>valid local names</var> is the list containing <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-q-element">q</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-blockquote-element">blockquote</a></code>, but <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a> is <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-p-element">p</a></code>, which is not in that list.</p>
            </div>
          </li>
        </ol>
      </li>

      <li>
        <p>Let <var>prototype</var> be <var>definition</var>'s <a href="#concept-custom-element-definition-prototype">prototype</a>.</p>
      </li>

      <li>
        <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a> is empty, then:</p>

        <ol>
          <li>
            <p>Let <var>element</var> be a new element that implements the interface to which the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> corresponds, with no attributes, namespace set to the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a>, local name set to <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object">current global object</a>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-window">associated <code>Document</code></a>.</p>
          </li>

          <li>
            <p>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</p>
          </li>

          <li>
            <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>custom</code>".</p>
          </li>

          <li>
            <p>Set <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a> to <var>definition</var>.</p>
          </li>

          <li>
            <p>Return <var>element</var>.</p>
          </li>
        </ol>

        <p class="note">This occurs when author script constructs a new custom element directly, e.g. via <code>new MyCustomElement()</code>.</p>
      </li>

      <li>
        <p>Let <var>element</var> be the last entry in <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>
      </li>

      <li>
        <p>If <var>element</var> is an <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a>, then throw an <a href="https://heycam.github.io/webidl/#invalidstateerror">"<code>InvalidStateError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>

        <div class="example">
          <p>This can occur when the author code inside the <a href="#custom-element-constructor">custom element constructor</a> <a href="#custom-element-conformance">non-conformantly</a> creates another instance of the class being constructed, before calling <code>super()</code>:</p>
          <pre>
let doSillyThing = false;

class DontDoThis extends HTMLElement {
  constructor() {
    if (doSillyThing) {
      doSillyThing = false;
      new DontDoThis();
      // Now the construction stack will contain an <i>already constructed</i> marker.
    }

    // This will then fail with an "InvalidStateError" DOMException:
    super();
  }
}
</pre>
        </div>

        <div class="example">
          <p>This can also occur when author code inside the <a href="#custom-element-constructor">custom element constructor</a> <a href="#custom-element-conformance">non-conformantly</a> calls <code>super()</code> twice, since per the JavaScript specification, this actually executes the superclass constructor (i.e. this algorithm) twice, before throwing an error:</p>
          <pre>
class DontDoThisEither extends HTMLElement {
  constructor() {
    super();

    // This will throw, but not until it has already called into the HTMLElement constructor
    super();
  }
}
</pre>
        </div>
      </li>

      <li>
        <p>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</p>
      </li>

      <li>
        <p>Replace the last entry in <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a> with an <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a>.</p>
      </li>

      <li>
        <p>Return <var>element</var>.</p>

        <p class="note">This step is normally reached when <a href="#upgrades">upgrading</a> a custom element; the existing element is returned, so that the <code>super()</code> call inside the <a href="#custom-element-constructor">custom element constructor</a> assigns that existing element to <b>this</b>.</p>
      </li>
    </ol>
    <hr>

    <p>In addition to the constructor behavior implied by <code><a href="#htmlconstructor">[HTMLConstructor]</a></code>, some elements also have <a href="https://heycam.github.io/webidl/#dfn-named-constructor">named constructors</a> (which are really factory functions with a modified <code>prototype</code> property).</p>

    <div class="example">
      <p>Named constructors for HTML elements can also be used in an <code>extends</code> clause when defining a <a href="#custom-element-constructor">custom element constructor</a>:</p>
      <pre>
class AutoEmbiggenedImage extends Image {
  constructor(width, height) {
    super(width * 10, height * 10);
  }
}

customElements.define("auto-embiggened", AutoEmbiggenedImage, { extends: "img" });

const image = new AutoEmbiggenedImage(15, 20);
console.assert(image.width === 150);
console.assert(image.height === 200);
</pre>
    </div>
  </section>

  <section>
    <h2>Miscellaneous patches</h2>

    <section id="window-modifications-to-html">
      <h3>HTML: The <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object</h3>

      <p>HTML's <code>Window</code> object definition must be extended as follows:</p>
      <pre class="idl">
partial interface Window {
    readonly attribute CustomElementRegistry customElements;
};
</pre>
    </section>

    <section>
      <h2>HTML: Pseudo-classes</h2>

      <dl>
        <dt><dfn id="selector-defined"><code>:defined</code></dfn></dt>

        <dd>
          <p>The <code><a href="#selector-defined">:defined</a></code> <a href="https://drafts.csswg.org/selectors/#pseudo-class">pseudo-class</a> must match any element that is <a href="#concept-element-defined">defined</a>.</p>
        </dd>
      </dl>
    </section>

    <section>
      <h2>HTML: Creating and inserting nodes</h2>

      <p>When the HTML parser requires the UA to <dfn id="create-an-element-for-the-token">create an element for a token</dfn> in a particular <var>given namespace</var> and with a particular <var>intended parent</var>, the UA must run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>document</var> be <var>intended parent</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</p>
        </li>

        <li>
          <p>Let <var>local name</var> be the tag name of the token.</p>
        </li>

        <li>
          <p>Let <var>is</var> be the value of the "<code><a href="#attr-is">is</a></code>" attribute in the given token, if such an attribute exists, or null otherwise.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>document</var>, <var>given namespace</var>, <var>local name</var>, and <var>is</var>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is non-null and the parser was not originally created for the <a href="https://html.spec.whatwg.org/multipage/#html-fragment-parsing-algorithm">HTML fragment parsing algorithm</a>, then let <var>will execute script</var> be true. Otherwise, let it be false.</p>
        </li>

        <li>
          <p>If <var>will execute script</var> is true, then:</p>

          <ol>
            <li>
              <p>Increment <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>.</p>
            </li>

            <li>
              <p>If the <a href="https://tc39.github.io/ecma262/#execution-context-stack">JavaScript execution context stack</a> is empty, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint">perform a microtask checkpoint</a>.</p>
            </li>

            <li>
              <p>Push a new <a href="#element-queue">element queue</a> onto the <a href="#custom-element-reactions-stack">custom element reactions stack</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Let <var>element</var> be the result of <a href="#concept-create-element">creating an element</a> given <var>document</var>, <var>localName</var>, <var>given namespace</var>, null, and <var>is</var>. If <var>will execute script</var> is true, set the <var>synchronous custom elements flag</var>; otherwise, leave it unset.</p>

          <p class="note">This will cause <a href="#custom-element-constructor">custom element constructors</a> to run, if <var>will execute script</var> is true. However, since we incremented the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>, this cannot cause <a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-write">new characters to be inserted into the tokenizer</a>, or <a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-open">the document to be blown away</a>.</p>

          <p>If this step throws an exception, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>, and let <var>element</var> be instead a new element that implements <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement">HTMLUnknownElement</a></code>, with no attributes, namespace set to <var>given namespace</var>, namespace prefix set to null, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>failed</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
        </li>

        <li>
          <p><a href="#concept-element-attributes-append">Append</a> each attribute in the given token to <var>element</var>.</p>

          <p class="note">This can <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> for the <code>attributeChangedCallback</code>, which might run immediately (in the next step).</p>

          <p class="note">Even though the <code><a href="#attr-is">is</a></code> attribute governs the <a href="#concept-create-element">creation</a> of a <a href="#customized-built-in-element">customized built-in element</a>, it is not present during the execution of the relevant <a href="#custom-element-constructor">custom element constructor</a>; it is appended in this step, along with all other attributes.</p>
        </li>

        <li>
          <p>If <var>will execute script</var> is true, then:</p>

          <ol>
            <li>
              <p>Let <var>queue</var> be the result of popping the <a href="#current-element-queue">current element queue</a> from the <a href="#custom-element-reactions-stack">custom element reactions stack</a>. (This will be the same <a href="#element-queue">element queue</a> as was pushed above.)</p>
            </li>

            <li>
              <p><a href="#invoke-custom-element-reactions">Invoke custom element reactions</a> in <var>queue</var>.</p>
            </li>

            <li>
              <p>Decrement <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If <var>element</var> has an <code>xmlns</code> attribute <em>in the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xmlns-namespace">XMLNS namespace</a></em> whose value is not exactly the same as the element's namespace, that is a <a href="https://html.spec.whatwg.org/multipage/#parse-error">parse error</a>. Similarly, if <var>element</var> has an <code>xmlns:xlink</code> attribute in the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xmlns-namespace">XMLNS namespace</a> whose value is not the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xlink-namespace">XLink Namespace</a>, that is a <a href="https://html.spec.whatwg.org/multipage/#parse-error">parse error</a>.</p>
        </li>

        <li>
          <p>If <var>element</var> is a <a href="https://html.spec.whatwg.org/multipage/forms.html#category-reset">resettable element</a>, invoke its <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-reset-control">reset algorithm</a>. (This initialises the element's <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-fe-value">value</a> and <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-fe-checked">checkedness</a> based on the element's attributes.)</p>
        </li>

        <li>
          <p>If <var>element</var> is a <a href="https://html.spec.whatwg.org/multipage/forms.html#form-associated-element">form-associated element</a>, and the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a> is not null, and there is no <code><a href="https://html.spec.whatwg.org/multipage/scripting.html#the-template-element">template</a></code> element on the <a href="https://html.spec.whatwg.org/multipage/#stack-of-open-elements">stack of open elements</a>, and <var>element</var> is either not <a href="https://html.spec.whatwg.org/multipage/forms.html#category-listed">listed</a> or doesn't have a <code><a href="https://html.spec.whatwg.org/multipage/forms.html#attr-fae-form">form</a></code> attribute, and the <var>intended parent</var> is in the same <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> as the element pointed to by the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a>, <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-association">associate</a> <var>element</var> with the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-form-element">form</a></code> element pointed to by the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a>, and suppress the running of the <a href="https://html.spec.whatwg.org/multipage/forms.html#reset-the-form-owner">reset the form owner</a> algorithm when the parser subsequently attempts to insert the element.</p>
        </li>

        <li>
          <p>Return <var>element</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h2>HTML: Parsing XHTML documents</h2>

      <p>When creating DOM nodes representing elements, the <a href="#create-an-element-for-the-token">create an element for a token</a> algorithm or some equivalent that operates on appropriate XML datastructures must be used, to ensure the proper <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interfaces</a> are created and that <a href="#custom-element">custom elements</a> are set up correctly.</p>
    </section>

    <section>
      <h2>HTML: Content model</h2>

      <p>HTML has several sections that need to be updated when introducing a new element, or in this case class of elements. The necessary changes are:</p>

      <ul>
        <li>
          <p><a href="https://html.spec.whatwg.org/multipage/dom.html#content-categories">The categories venn diagram</a>'s interactive list must include <a href="#autonomous-custom-element">autonomous custom elements</a> in phrasing and flow content.</p>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#flow-content-2">Flow content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">Phrasing content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#palpable-content-2">Palpable content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/indices.html#elements-3">The elements index</a> must include a row at the bottom for <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/indices.html#element-content-categories">The element content categories index</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a> in the flow content, phrasing content, and palpable content sections
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission">Tag omission</a> must note that <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-p-element"><code>p</code></a> element end tags cannot be omitted if the element's parent is an <a href="#autonomous-custom-element">autonomous custom element</a>
        </li>
      </ul>
    </section>

    <section>
      <h2>HTML: Wide-ranging patches</h2>

      <p>All IDL attributes in HTML which could potentially cause DOM mutations have been updated to be annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute.</p>

      <p>All HTML interfaces representing a HTML element have been updated to be annotated with the <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute.</p>

      <p>All places in HTML that create elements have been updated to use the new <a href="#concept-create-element">create an element</a> algorithm.</p>
    </section>

    <section>
      <h2>DOM: Elements</h2>

      <p><a href="https://dom.spec.whatwg.org/#concept-element">Elements</a> have an associated <dfn id="concept-element-namespace">namespace</dfn>, <dfn id="concept-element-namespace-prefix">namespace prefix</dfn>, <dfn id="concept-element-local-name">local name</dfn>, <dfn id="concept-element-custom-element-state">custom element state</dfn>, <dfn id="concept-element-custom-element-definition">custom element definition</dfn>, <dfn id="concept-element-is-value"><code>is</code> value</dfn>. When an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> is <a href="#concept-create-element">created</a>, all of these values are initialized.</p>

      <p>An <a href="https://dom.spec.whatwg.org/#concept-element">element</a>’s <a href="#concept-element-custom-element-state">custom element state</a> is one of "<code>undefined</code>", "<code>failed</code>", "<code>uncustomized</code>", or "<code>custom</code>". An <a href="https://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="#concept-element-custom-element-state">custom element state</a> is "<code>uncustomized</code>" or "<code>custom</code>" is said to be <dfn id="concept-element-defined">defined</dfn>. An <a href="https://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="#concept-element-custom-element-state">custom element state</a> is "<code>custom</code>" is said to be <dfn id="concept-element-custom">custom</dfn>.</p>

      <p class="note" role="note">Whether or not an element is <a href="#concept-element-defined">defined</a> is used to determine the behavior of the <a class="css" href="#selector-defined">:defined</a> pseudo-class. Whether or not an element is <a href="#concept-element-custom">custom</a> is used to determine the behavior of the <a href="https://dom.spec.whatwg.org/#mutation-algorithms">mutation algorithms</a>. The "<code>failed</code>" state is used to ensure that if a <a href="#custom-element-constructor">custom element constructor</a> fails to execute correctly the first time, it is not executed again by an <a href="#concept-upgrade-an-element">upgrade</a>.</p>

      <div class="example">
        <p>The following code illustrates elements in each of these four states:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;script&gt;
  window.customElements.define("sw-rey", class extends HTMLElement {})
  window.customElements.define("sw-finn", class extends HTMLElement {}, { extends: "p" })
  window.customElements.define("sw-kylo", class extends HTMLElement {
    constructor() {
      // super() intentionally omitted for this example
    }
  })
&lt;/script&gt;

&lt;!-- "undefined" (not defined, not custom) --&gt;
&lt;sw-han&gt;&lt;/sw-han&gt;
&lt;p is="sw-luke"&gt;&lt;/p&gt;
&lt;p is="asdf"&gt;&lt;/p&gt;

&lt;!-- "failed" (not defined, not custom) --&gt;
&lt;sw-kylo&gt;&lt;/sw-kylo&gt;

&lt;!-- "uncustomized" (defined, not custom) --&gt;
&lt;p&gt;&lt;/p&gt;
&lt;asdf&gt;&lt;/asdf&gt;

&lt;!-- "custom" (defined, custom) --&gt;
&lt;sw-rey&gt;&lt;/sw-rey&gt;
&lt;p is="sw-finn"&gt;&lt;/p&gt;
</pre>
      </div>

      <p>To <dfn id="concept-create-element">create an element</dfn>, given a <var>document</var>, <var>localName</var>, <var>namespace</var>, and optional <var>prefix</var>, <var>is</var>, and <var>synchronous custom elements flag</var>, run these steps:</p>

      <ol>
        <li>
          <p>If <var>prefix</var> was not given, let <var>prefix</var> be null.</p>
        </li>

        <li>
          <p>If <var>is</var> was not given, let <var>is</var> be null.</p>
        </li>

        <li>
          <p>Let <var>result</var> be null.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>document</var>, <var>namespace</var>, <var>localName</var>, and <var>is</var>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is non-null, and <var>definition</var>’s <a href="#concept-custom-element-definition-name">name</a> is not equal to its <a href="#concept-custom-element-definition-local-name">local name</a> (i.e., <var>definition</var> represents a <a href="#customized-built-in-element">customized built-in element</a>), then:</p>

          <ol>
            <li>
              <p>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>.</p>
            </li>

            <li>
              <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>undefined</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to <var>is</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
            </li>

            <li>
              <p>If the <var>synchronous custom elements flag</var> is set, <a href="#concept-upgrade-an-element">upgrade</a> <var>element</var> using <var>definition</var>.</p>
            </li>

            <li>
              <p>Otherwise, <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, if <var>definition</var> is non-null, then:</p>

          <ol>
            <li>
              <p>If the <var>synchronous custom elements flag</var> is set:</p>

              <ol>
                <li>
                  <p>Let <var>C</var> be <var>definition</var>’s <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
                </li>

                <li>
                  <p>Set <var>result</var> to <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>result</var> does not implement the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code>.</p>

                  <div class="note" role="note">
                    <p>This is meant to be a brand check to ensure that the object was allocated by the a HTML element constructor. See <a href="https://github.com/heycam/webidl/issues/97">webidl #97</a> about making this more precise.</p>

                    <p>If this check passes, then <var>result</var> will already have its <a href="#concept-element-custom-element-state">custom element state</a> and <a href="#concept-element-custom-element-definition">custom element definition</a> initialized.</p>
                  </div>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a> is not empty, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var> has <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-parent">parent</a> is not null, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> is not <var>document</var>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="#concept-element-namespace">namespace</a> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>

                  <p class="note" role="note">As of the time of this writing, every element that implements the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface is also in the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, so this check is currently redundant with the above brand check. However, this is not guaranteed to be true forever in the face of potential specification changes, such as converging certain SVG and HTML interfaces.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="#concept-element-local-name">local name</a> is not equal to <var>localName</var>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>Set <var>result</var>’s <a href="#concept-element-namespace-prefix">namespace prefix</a> to <var>prefix</var>.</p>
                </li>

                <li>
                  <p>Set <var>result</var>’s <a href="#concept-element-is-value"><code>is</code> value</a> to null.</p>
                </li>
              </ol>
            </li>

            <li>
              <p>Otherwise:</p>

              <ol>
                <li>
                  <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, with no attributes, <a href="#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>undefined</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to null, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
                </li>

                <li>
                  <p><a href="#enqueue-a-custom-element-upgrade-reaction">Enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise:</p>

          <ol>
            <li>
              <p>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and <var>namespace</var>.</p>
            </li>

            <li>
              <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="#concept-element-namespace">namespace</a> set to <var>namespace</var>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>uncustomized</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to <var>is</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
            </li>

            <li>
              <p>If <var>namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and either <var>localName</var> is a <a href="#valid-custom-element-name">valid custom element name</a> or <var>is</var> is non-null, then set <var>result</var>’s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>undefined</code>".</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Return <var>result</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-change">change</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> from an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var> to <var>value</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a> to <var>value</var>.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-append">append</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> to an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue null.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Append the <var>attribute</var> to the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to <var>element</var>.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-remove">remove</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> from an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Remove <var>attribute</var> from the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to null.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-replace">replace</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>oldAttr</var> by an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>newAttr</var> in an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <p><a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.</p>
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>
          <p>Replace <var>oldAttr</var> by <var>newAttr</var> in the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.</p>
        </li>

        <li>
          <p>Set <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to null.</p>
        </li>

        <li>
          <p>Set <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to <var>element</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h2>DOM: Cloning</h2>

      <p>To <dfn data-local-lt="clone" id="concept-node-clone">clone</dfn> a <var>node</var>, with an optional <var>document</var> and <i>clone children flag</i>, run these steps:</p>

      <ol>
        <li>
          <p>If <var>document</var> is not given, let <var>document</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</p>
        </li>

        <li>
          <p>If <var>node</var> is an <a href="https://dom.spec.whatwg.org/#concept-element">element</a>, then:</p>

          <ol>
            <li>
              <p>Let <var>copy</var> be the result of <a href="#concept-create-element">creating an element</a>, given <var>document</var>, <var>node</var>’s <a href="#concept-element-local-name">local name</a>, <var>node</var>’s <a href="#concept-element-namespace">namespace</a>, <var>node</var>’s <a href="#concept-element-namespace-prefix">namespace prefix</a>, and the value of <var>node</var>’s <code>is</code> attribute if present (or null if not). The <var>synchronous custom elements flag</var> should be unset.</p>
            </li>

            <li>
              <p>For each <var>attribute</var> in <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>, in order, run these substeps:</p>

              <ol>
                <li>
                  <p>Let <var>copyAttribute</var> be a <a href="#concept-node-clone">clone</a> of <var>attribute</var>.</p>
                </li>

                <li>
                  <p><a href="#concept-element-attributes-append">Append</a> <var>copyAttribute</var> to <var>copy</var>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, let <var>copy</var> be a <a href="https://dom.spec.whatwg.org/#concept-node">node</a> that implements the same interfaces as <var>node</var>, and fulfills these additional requirements, switching on <var>node</var>:</p>

          <dl class="switch">
            <dt><code><a href="https://dom.spec.whatwg.org/#document">Document</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-document-encoding">encoding</a>, <a href="https://dom.spec.whatwg.org/#concept-document-content-type">content type</a>, <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a>, <a href="https://dom.spec.whatwg.org/#concept-document-type">type</a>, and <a href="https://dom.spec.whatwg.org/#concept-document-mode">mode</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#documenttype">DocumentType</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-doctype-name">name</a>, <a href="https://dom.spec.whatwg.org/#concept-doctype-publicid">public ID</a>, and <a href="https://dom.spec.whatwg.org/#concept-doctype-systemid">system ID</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#attr">Attr</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace-prefix">namespace prefix</a>, <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, and <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#text">Text</a></code></dt>

            <dt><code><a href="https://dom.spec.whatwg.org/#comment">Comment</a></code></dt>

            <dd>
              Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-cd-data">data</a>, to that of <var>node</var>.
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#processinginstruction">ProcessingInstruction</a></code></dt>

            <dd>
              Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-pi-target">target</a> and <a href="https://dom.spec.whatwg.org/#concept-cd-data">data</a> to those of <var>node</var>.
            </dd>

            <dt>Any other node</dt>

            <dd>—</dd>
          </dl>
        </li>

        <li>
          <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> and <var>document</var> to <var>copy</var>, if <var>copy</var> is a <a href="https://dom.spec.whatwg.org/#concept-document">document</a>, and set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> to <var>document</var> otherwise.</p>
        </li>

        <li>Run any <a href="https://dom.spec.whatwg.org/#concept-node-clone-ext">cloning steps</a> defined for <var>node</var> in <a href="https://dom.spec.whatwg.org/#other-applicable-specifications">other applicable specifications</a> and pass <var>copy</var>, <var>node</var>, <var>document</var> and the <i>clone children flag</i> if set, as parameters.
        </li>

        <li>If the <i>clone children flag</i> is set, <a href="#concept-node-clone">clone</a> all the <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> of <var>node</var> and append them to <var>copy</var>, with <var>document</var> as specified and the <i>clone children flag</i> being set.
        </li>

        <li>Return <var>copy</var>.</li>
      </ol>
    </section>

    <section>
      <h2>DOM: Mutation algorithms</h2>

      <p>To <dfn id="concept-node-insert">insert</dfn> a <var>node</var> into a <var>parent</var> before a <var>child</var>, with an optional <i>suppress observers flag</i>, run these steps:</p>

      <ol>
        <li>Let <var>count</var> be the number of <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> of <var>node</var> if it is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, and one otherwise.
        </li>

        <li>If <var>child</var> is non-null, run these substeps:

          <ol>
            <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> is greater than <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>, increase its <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> by <var>count</var>.
            </li>

            <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> is greater than <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>, increase its <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> by <var>count</var>.
            </li>
          </ol>
        </li>

        <li>Let <var>nodes</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> if <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, and a list containing solely <var>node</var> otherwise.
        </li>

        <li>If <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, <a href="#concept-node-remove">remove</a> its <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> with the <i>suppress observers flag</i> set.
        </li>

        <li>If <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>node</var> with removedNodes <var>nodes</var>.

          <p class="note no-backref" role="note">This step intentionally does not pay attention to the <i>suppress observers flag</i>.</p>
        </li>

        <li>
          <p>For each <var>node</var> in <var>nodes</var>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, run these substeps:</p>

          <ol>
            <li>
              <p>Insert <var>node</var> into <var>parent</var> before <var>child</var> or at the end of <var>parent</var> if <var>child</var> is null.</p>
            </li>

            <li>
              <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#element-shadow-host">shadow host</a> and <var>node</var> is a <a href="https://dom.spec.whatwg.org/#concept-slotable">slotable</a>, then <a href="https://dom.spec.whatwg.org/#assign-a-slot">assign a slot</a> for <var>node</var>.</p>
            </li>

            <li>
              <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a> whose <a href="https://dom.spec.whatwg.org/#slot-assigned-nodes">assigned nodes</a> is the empty list, then run <a href="https://dom.spec.whatwg.org/#signal-a-slot-change">signal a slot change</a> for <var>parent</var>.</p>
            </li>

            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> and a set containing each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>.</p>
            </li>

            <li>
              <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these subsubsteps:</p>

              <ol>
                <li>
                  <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-insert-ext">insertion steps</a> with <var>inclusiveDescendant</var>.</p>
                </li>

                <li>
                  <p>If <var>inclusiveDescendant</var> is <a href="https://dom.spec.whatwg.org/#connected">connected</a>, then:</p>

                  <ol>
                    <li>
                      <p>If <var>inclusiveDescendant</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>inclusiveDescendant</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</p>
                    </li>

                    <li>
                      <p>Otherwise, <a href="#concept-try-upgrade">try to upgrade</a> <var>inclusiveDescendant</var>.</p>

                      <p class="note" role="note">If this successfully upgrades <var>inclusiveDescendant</var>, its <code>connectedCallback</code> will be enqueued automatically during the <a href="#concept-upgrade-an-element">upgrade an element</a> algorithm.</p>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>If <i>suppress observers flag</i> is unset, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with addedNodes <var>nodes</var>, nextSibling <var>child</var>, and previousSibling <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-previous-sibling">previous sibling</a> or <var>parent</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-last-child">last child</a> if <var>child</var> is null.
        </li>
      </ol>

      <p>To <dfn id="concept-node-remove">remove</dfn> a <var>node</var> from a <var>parent</var>, with an optional <i>suppress observers flag</i>, run these steps:</p>

      <ol>
        <li>Let <var>index</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>.
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a href="https://dom.spec.whatwg.org/#concept-range-start">start</a> to (<var>parent</var>, <var>index</var>).
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a href="https://dom.spec.whatwg.org/#concept-range-end">end</a> to (<var>parent</var>, <var>index</var>).
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> is greater than <var>index</var>, decrease its <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> by one.
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> is greater than <var>index</var>, decrease its <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> by one.
        </li>

        <li>
          <p>For each <code><a href="https://dom.spec.whatwg.org/#nodeiterator">NodeIterator</a></code> object <var>iterator</var> whose <a href="https://dom.spec.whatwg.org/#concept-traversal-root">root</a>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> is <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>, run the <a href="https://dom.spec.whatwg.org/#nodeiterator-pre-removing-steps"><code>NodeIterator</code> pre-removing steps</a> given <var>node</var> and <var>iterator</var>.</p>
        </li>

        <li>Let <var>oldPreviousSibling</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-previous-sibling">previous sibling</a>.
        </li>

        <li>Let <var>oldNextSibling</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-next-sibling">next sibling</a>.
        </li>

        <li>Remove <var>node</var> from its <var>parent</var>.</li>

        <li>
          <p>If <var>node</var> is <a href="https://dom.spec.whatwg.org/#slotable-assigned">assigned</a>, then run <a href="https://dom.spec.whatwg.org/#assign-slotables">assign slotables</a> for <var>node</var>’s <a href="https://dom.spec.whatwg.org/#slotable-assigned-slot">assigned slot</a>.</p>
        </li>

        <li>
          <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a> whose <a href="https://dom.spec.whatwg.org/#slot-assigned-nodes">assigned nodes</a> is the empty list, then run <a href="https://dom.spec.whatwg.org/#signal-a-slot-change">signal a slot change</a> for <var>parent</var>.</p>
        </li>

        <li>
          <p>If <var>node</var> has an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>, then:</p>

          <ol>
            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>parent</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a>.</p>
            </li>

            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> and a set containing each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>node</var> and <var>parent</var>.</p>
        </li>

        <li>
          <p>If <var>node</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>node</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</p>

          <p class="note" role="note">It is intentional for now that <a href="#concept-element-custom">custom</a> <a href="https://dom.spec.whatwg.org/#concept-element">elements</a> do not get <var>parent</var> passed. This might change in the future if there is a need.</p>
        </li>

        <li>
          <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant">shadow-including descendant</a> <var>descendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these substeps:</p>

          <ol>
            <li>
              <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>descendant</var>.</p>
            </li>

            <li>
              <p>If <var>descendant</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>descendant</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</p>
            </li>
          </ol>
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> <var>inclusiveAncestor</var> of <var>parent</var>, if <var>inclusiveAncestor</var> has any <a href="https://dom.spec.whatwg.org/#registered-observer">registered observers</a> whose <b>options</b>' <code><a href="https://dom.spec.whatwg.org/#dom-mutationobserverinit-subtree">subtree</a></code> is true, then for each such <a href="https://dom.spec.whatwg.org/#registered-observer">registered observer</a> <var>registered</var>, append a <a href="https://dom.spec.whatwg.org/#transient-registered-observer">transient registered observer</a> whose <b>observer</b> and <b>options</b> are identical to those of <var>registered</var> and <b>source</b> which is <var>registered</var> to <var>node</var>’s list of <a href="https://dom.spec.whatwg.org/#registered-observer">registered observers</a>.
        </li>

        <li>If <i>suppress observers flag</i> is unset, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with removedNodes a list solely containing <var>node</var>, nextSibling <var>oldNextSibling</var>, and previousSibling <var>oldPreviousSibling</var>.
        </li>
      </ol>
    </section>

    <section>
      <h2>DOM: Wide-ranging patches</h2>

      <p>All IDL attributes in DOM which could potentially cause DOM mutations have been updated to be annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute.</p>

      <p>All places in DOM that create elements have been updated to use the new <a href="#concept-create-element">create an element</a> algorithm. At the time of this writing, apart from the above <a href="https://html.spec.whatwg.org/multipage/#dom-document-createelement"><code>createElement()</code></a> and <a href="https://html.spec.whatwg.org/multipage/#dom-document-createelementns"><code>createElementNS()</code></a> definitions, only <a href="https://dom.spec.whatwg.org/#dom-domimplementation-createhtmldocument"><code>createHTMLDocument()</code></a> creates elements.</p>
    </section>
  </section>

  <section id="appendix-a" class="appendix informative">
    <h2>Acknowledgments</h2>

    <p>David Hyatt developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and Ian Hickson co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

    <p>Alex Russell and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

    <p>Dominic Cooney, Hajime Morrita, and Roland Steiner worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

    <p><a href="mailto:sfaulkner@paciellogroup.com">Steve Faulkner</a>, The Paciello Group, for what formed the basis of the introductory examples.</p>

    <div itemscope="" itemtype="http://n.whatwg.org/work">
      <p>The &lt;flag-icon&gt; example was inspired by <a itemprop="work" href="https://customelements.io/stevenrskelton/flag-icon/">a custom element</a> by <a itemprop="https://creativecommons.org/ns#attributionURL" href="http://stevenskelton.ca/">Steven Skelton</a>. (<a itemprop="license" href="https://opensource.org/licenses/MIT">MIT</a>)</p>
    </div>

    <p>The editor would also like to thank Alex Komoroske, Andres Rios, Anne van Kesteren, Boris Zbarsky, Daniel Buchner, Edward O'Connor, Erik Arvidsson, Elliott Sprehn, Hayato Ito, Jan Miksovsky, Jonas Sicking, Koji Ishii, Olli Pettay, Rafael Weinstein, Ryosuke Niwa, Scott Miles, Simon Pieters, Steve Orvell, Tab Atkins, Tim Perry, and William Chen for their comments and contributions to this specification.</p>
  </section>
</body>
</html>
